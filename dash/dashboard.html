{% extends "dashboard_base.html" %}
{% block dashboard_content %}
    <style>
        /* Main dashboard layout with sidebar */
        .dashboard-container {
            display: grid;
            grid-template-columns: var(--sidebar-width, 20%) 1fr;
            min-height: 100vh;
            position: relative;
        }
        .sidebar-resizer {
            position: absolute;
            left: calc(var(--sidebar-width, 20%));
            top: 0;
            width: 6px;
            height: 100vh;
            cursor: col-resize;
            background: transparent;
            border-left: 2px solid transparent;
            z-index: 200;
        }
        .sidebar-resizer:hover, .sidebar-resizer.active {
            border-left-color: #0d6efd;
        }
        
        /* Fixed left sidebar */
        #sidebar {
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 1rem;
            z-index: 100;
        }
        
        #sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        #sidebar::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        
        /* Main content area */
        #dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            grid-auto-flow: dense;
            gap: 1rem;
            max-width: 100%;
            padding: 1.25rem;
            align-content: start;
        }
        
        /* Module sizing */
        .dashboard-module {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: transparent;
            border-radius: 0.5rem;
            container-type: inline-size;
        }
        
        .dashboard-module.full-width {
            grid-column: 1 / -1;
        }
        
        .dashboard-module.wide {
            grid-column: span 2;
        }
        
        .dashboard-module.half {
            grid-column: span 1;
        }
        
        /* Drag and drop states */
        .dashboard-module.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            z-index: 1000;
            box-shadow: 0 12px 32px rgba(0,0,0,0.3);
            cursor: grabbing;
        }
        
        .dashboard-module.hidden {
            display: none;
        }
        
        .dashboard-module.drag-over {
            border: 2px solid #0d6efd;
            background-color: rgba(13, 110, 253, 0.08);
            border-radius: 0.5rem;
        }
        
        .drop-zone {
            position: relative;
            min-height: 60px;
            border: 2px dashed var(--border-color);
            border-radius: 0.5rem;
            background: linear-gradient(135deg, rgba(13, 110, 253, 0.03) 0%, rgba(13, 110, 253, 0.06) 100%);
            transition: all 0.25s ease;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .drop-zone.active {
            display: flex;
            border-color: #0d6efd;
            border-width: 3px;
            background: linear-gradient(135deg, rgba(13, 110, 253, 0.1) 0%, rgba(13, 110, 253, 0.15) 100%);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        /* Card styling */
        .dashboard-module .card {
            height: 100%;
            margin-bottom: 0;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: box-shadow 0.3s ease, transform 0.2s ease;
        }
        .dashboard-module .card-body {
            overflow: hidden;
            overflow-x: auto;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }
        .dashboard-module table {
            table-layout: auto;
            width: 100%;
            max-width: 100%;
        }
        .dashboard-module td,
        .dashboard-module th {
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* Drag handle styling */
        .drag-handle {
            cursor: grab;
            padding: 0 0.5rem;
            opacity: 0.6;
            transition: opacity 0.2s ease;
        }
        
        .drag-handle:hover {
            opacity: 1;
        }
        
        .drag-handle:active {
            cursor: grabbing;
        }
        
        .dashboard-module[draggable="true"] .card-header {
            cursor: move;
        }
        
        .dashboard-module .card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        
        .dashboard-module.dragging .card {
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }
        .hide-toggle {
            cursor: pointer;
            padding: 4px 10px;
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-left: 8px;
            transition: color 0.2s;
        }
        .hide-toggle:hover {
            color: #dc3545;
        }
        .custom-widget-content {
            min-height: 150px;
        }
        .copy-value {
            cursor: pointer;
            text-decoration: underline;
            text-decoration-style: dotted;
            text-underline-offset: 2px;
        }
        .copy-value:hover {
            color: #0d6efd;
        }
        /* Responsive grid adjustments */
        @media (max-width: 1400px) {
                    /* Resizable table columns */
                    .resizable-table {
                        position: relative;
                        width: 100%;
                    }
        
                    .resizable-table th {
                        position: relative;
                        user-select: none;
                    }
        
                    .resize-handle {
                        position: absolute;
                        top: 0;
                        right: 0;
                        width: 8px;
                        height: 100%;
                        cursor: col-resize;
                        z-index: 1;
                        background: transparent;
                        border-right: 2px solid transparent;
                        transition: border-color 0.2s;
                    }
        
                    .resize-handle:hover,
                    .resize-handle.active {
                        border-right-color: #0d6efd;
                    }
        
                    /* Mobile: hide sidebar */
                    @media (max-width: 992px) {
                        .dashboard-container {
                            grid-template-columns: 1fr;
                        }
                        #sidebar {
                            position: relative;
                            height: auto;
                            border-right: none;
                            border-bottom: 1px solid var(--border-color);
                        }
                        #dashboard-grid {
                            padding: 1rem;
                        }
                    }
        
                    @media (max-width: 1400px) {
            #dashboard-grid {
                grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                gap: 1rem;
            }
            .dashboard-module.wide {
                grid-column: span 1;
            }
        }
        
        @media (max-width: 992px) {
            #dashboard-grid {
                grid-template-columns: 1fr;
                padding: 1rem;
                gap: 1rem;
            }
            .dashboard-module.wide,
            .dashboard-module.half {
                grid-column: span 1;
            }
        }
        
        @media (max-width: 768px) {
            #dashboard-grid {
                padding: 0.75rem;
                gap: 0.75rem;
                grid-template-columns: 1fr;
            }
            .dashboard-module .card-header {
                padding: 0.85rem 1rem;
                font-size: 1rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .dashboard-module .card-body {
                padding: 0.75rem;
            }
            .dashboard-module table {
                font-size: 0.85rem;
            }
            .dashboard-module td,
            .dashboard-module th {
                padding: 0.5rem 0.4rem;
            }
            /* Make tables horizontally scrollable */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                max-width: 100%;
            }
            .dashboard-module table {
                font-size: 0.85rem;
                min-width: 100%;
            }
            /* Ensure content doesn't overflow */
            .dashboard-module .card-body {
                padding: 0.75rem;
                overflow-x: auto;
            }
            /* Larger buttons on mobile */
            .btn {
                min-height: 44px;
                padding: 0.5rem 0.875rem;
            }
            .btn-sm {
                min-height: 44px;
                padding: 0.5rem 0.75rem;
                font-size: 0.95rem;
            }
            /* Stack action buttons vertically */
            .text-end.mb-3 {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }
            .text-end.mb-3 .btn,
            .text-end.mb-3 a {
                width: 100%;
                text-align: center;
            }
            /* Collapsible card headers on mobile */
            .dashboard-module .card-header {
                cursor: pointer;
                user-select: none;
            }
            .dashboard-module .card-header::after {
                content: '\f282';
                font-family: 'bootstrap-icons';
                float: right;
                transition: transform 0.3s;
            }
            .dashboard-module.collapsed .card-header::after {
                transform: rotate(-90deg);
            }
            .dashboard-module.collapsed .card-body {
                display: none;
            }
        }
        @media (max-width: 480px) {
            .dashboard-title {
                font-size: 1.5rem;
            }
            .dashboard-module .card-header {
                font-size: 0.95rem;
            }
            .dashboard-module table {
                font-size: 0.8rem;
            }
        }
    </style>
    
    <!-- Main Dashboard Container -->
    <div class="container-fluid p-0" style="max-width: 100%;">
        <div class="dashboard-container">
            <!-- Fixed Left Sidebar -->
            <div id="sidebar">
                <!-- Service Status in Sidebar -->
                <div class="card mb-3">
                    <div class="card-header">
                        <b><small>Service Status</small></b>
                    </div>
                    <div class="card-body p-2">
                        <div class="mb-1">
                            <small><b>Status:</b></small>
                            <span id="service-badge-sidebar" class="badge bg-{{ 'success' if service_status == 'Running' else 'danger' }} ms-1" style="font-size: 0.7rem;">{{ service_status }}</span>
                        </div>
                        <div class="d-flex gap-1 flex-wrap">
                            <button class="btn btn-success btn-sm" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;" onclick="startService()">Start</button>
                            <button class="btn btn-danger btn-sm" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;" onclick="stopService()">Stop</button>
                            <button class="btn btn-warning btn-sm" style="font-size: 0.7rem; padding: 0.25rem 0.5rem;" onclick="restartService()">Restart</button>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="card mb-3">
                    <div class="card-header">
                        <b><small>Quick Actions</small></b>
                    </div>
                    <div class="card-body p-2">
                        <div class="d-grid gap-1">
                            <button id="login-btn-sidebar" class="btn btn-outline-primary btn-sm" style="font-size: 0.75rem;" onclick="promptLogin()">Login</button>
                            <button id="logout-btn-sidebar" class="btn btn-outline-secondary btn-sm d-none" style="font-size: 0.75rem;" onclick="logout()">Logout</button>
                            <a id="config-link-sidebar" href="/config" class="btn btn-outline-success btn-sm d-none" style="font-size: 0.75rem;"><i class="bi bi-gear-fill"></i> Config</a>
                            <button class="btn btn-outline-info btn-sm" style="font-size: 0.75rem;" onclick="showHiddenModules()"><i class="bi bi-eye"></i> Show Hidden</button>
                            <button class="btn btn-outline-warning btn-sm" style="font-size: 0.75rem;" onclick="resetDashboardLayout()"><i class="bi bi-arrow-clockwise"></i> Reset Layout</button>
                            <button class="btn btn-outline-primary btn-sm" style="font-size: 0.75rem;" onclick="addCustomWidget()"><i class="bi bi-plus-circle"></i> Add Widget</button>
                        </div>
                    </div>
                </div>
                
                <!-- Links -->
                <div class="card">
                    <div class="card-header">
                        <b><small>Resources</small></b>
                    </div>
                    <div class="card-body p-2">
                        <div class="d-grid gap-1">
                            <a href="https://github.com/Atomsk865/DownloadsOrganizeR" target="_blank" class="btn btn-outline-dark btn-sm" style="font-size: 0.75rem;">GitHub</a>
                            <button id="dev-reset-btn-sidebar" class="btn btn-outline-danger btn-sm" style="font-size: 0.75rem;" onclick="devResetToSetup()"><i class="bi bi-exclamation-triangle"></i> DEV Reset</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Draggable resizer between sidebar and content -->
            <div class="sidebar-resizer" id="sidebar-resizer"></div>
            
            <!-- Main Content Grid -->
            <div id="dashboard-grid">
                    <button id="login-btn" class="btn btn-outline-primary btn-sm" onclick="promptLogin()">Login</button>
                    <button id="logout-btn" class="btn btn-outline-secondary btn-sm d-none" onclick="logout()">Logout</button>
                    <a id="config-link" href="/config" class="btn btn-outline-success btn-sm d-none" title="Dashboard Configuration"><i class="bi bi-gear-fill"></i> Config</a>
                    <button id="reset-layout-btn" class="btn btn-outline-warning btn-sm d-none" onclick="resetDashboardLayout()" title="Reset to default layout"><i class="bi bi-arrow-clockwise"></i> Reset Layout</button>
                    <button id="show-hidden-btn" class="btn btn-outline-info btn-sm d-none" onclick="showHiddenModules()" title="Show hidden modules"><i class="bi bi-eye"></i> Show Hidden</button>
                    <button id="dev-reset-btn" class="btn btn-outline-danger btn-sm" onclick="devResetToSetup()" title="DEV: Delete all config and force setup wizard"><i class="bi bi-exclamation-triangle"></i> DEV Reset</button>
                    <a href="https://github.com/Atomsk865/DownloadsOrganizeR" target="_blank" class="btn btn-outline-dark btn-sm">GitHub</a>
                    <button id="service-name-btn" class="btn btn-outline-info btn-sm" style="display:none;" onclick="copyServiceName()" title="Click to copy service name">Service: <span id="service-name">...</span></button>
                </div>
            </div>
            <!-- System Info Card (Top, non-draggable) -->
            <div class="dashboard-module wide" data-module="system-info" draggable="false">
                <div class="card">
                    <div class="card-header d-flex align-items-center">
                        <b>System Information</b>
                        <small class="ms-2" style="color: var(--text-secondary);">(Server vs Client; click to copy)</small>
                    </div>
                    <div class="card-body p-2">
                        <!-- Env mismatch warning injected by JS -->
                        <div id="env-mismatch" class="alert alert-warning py-2 px-3 mb-2" style="display:none;">
                            <strong>Heads up:</strong> Your browser appears to be on Windows while the server reports Linux. Make sure you're viewing the dashboard hosted on your Windows machine (not Codespaces).
                        </div>
                        <!-- Server (host) info -->
                        <div class="mb-2"><span class="badge bg-secondary">Server</span></div>
                        <div class="row">
                            <div class="col-md-3"><small><b>Hostname:</b> <span class="copy-value" onclick="copyToClipboard('{{ hostname }}', this)" title="Click to copy">{{ hostname }}</span></small></div>
                            <div class="col-md-3"><small><b>OS:</b> <span class="copy-value" onclick="copyToClipboard('{{ os }}', this)" title="Click to copy">{{ os }}</span></small></div>
                            <div class="col-md-3"><small><b>CPU:</b> <span class="copy-value" onclick="copyToClipboard('{{ cpu }}', this)" title="Click to copy">{{ cpu }}</span></small></div>
                            <div class="col-md-3"><small><b>RAM:</b> <span class="copy-value" onclick="copyToClipboard('{{ ram_gb }} GB', this)" title="Click to copy">{{ ram_gb }} GB</span></small></div>
                        </div>
                        <div class="row mt-1">
                            <div class="col-md-3"><small><b>GPU:</b> <span class="copy-value" onclick="copyToClipboard('{{ gpu }}', this)" title="Click to copy">{{ gpu }}</span></small></div>
                            <div class="col-md-3"><small><b>Private IP:</b> <span class="copy-value" onclick="copyToClipboard('{{ private_ip }}', this)" title="Click to copy">{{ private_ip }}</span></small></div>
                            <div class="col-md-3">
                                <small><b>Public IP:</b> <span id="public-ip-display" class="copy-value" onclick="copyPublicIP(this)" onmouseover="revealPublicIP()" onmouseout="hidePublicIP()" title="Hover to reveal, click to copy" style="cursor:pointer;">•••.•••.•••.•••</span></small>
                                <iframe src="https://ipchicken.com" style="display:none;" id="ipchicken-frame" onload="extractPublicIP()"></iframe>
                            </div>
                            <div class="col-md-3">
                                <a href="https://www.speedtest.net/" target="_blank" class="btn btn-outline-secondary btn-sm">Speed Test</a>
                            </div>
                        </div>

                        <!-- Client (browser) info -->
                        <div class="mt-3 mb-2"><span class="badge bg-info" style="color:#000;">Client</span></div>
                        <div class="row">
                            <div class="col-md-6"><small><b>Client IP:</b> <span class="copy-value" onclick="copyToClipboard('{{ client_ip }}', this)" title="Click to copy">{{ client_ip }}</span></small></div>
                            <div class="col-md-6"><small><b>User-Agent:</b> <span class="copy-value" onclick="copyToClipboard('{{ client_ua }}', this)" title="Click to copy">{{ client_ua }}</span></small></div>
                        </div>
                        <div class="row mt-1">
                            <div class="col-md-6"><small><b>Platform:</b> <span id="client-platform" class="copy-value" onclick="copyToClipboard(document.getElementById('client-platform').innerText, this)" title="Click to copy">detecting…</span></small></div>
                            <div class="col-md-6"><small><b>Language:</b> <span id="client-lang" class="copy-value" onclick="copyToClipboard(document.getElementById('client-lang').innerText, this)" title="Click to copy">detecting…</span></small></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Service Status -->
            <div class="dashboard-module wide" data-module="service-status" draggable="true">
                    <div class="card">
                        <div class="card-header d-flex align-items-center">
                            <b><i class="bi bi-activity"></i> Resource Monitor</b>
                            <span class="hide-toggle" onclick="toggleHideModule('service-status')" title="Hide module"><i class="bi bi-x-circle"></i></span>
                            <span class="drag-handle ms-auto"><i class="bi bi-grip-vertical"></i></span>
                        </div>
                        <div class="card-body p-2">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <small><b>Service Status:</b></small>
                                        <span id="service-badge" class="badge bg-{{ 'success' if service_status == 'Running' else 'danger' }} ms-1">{{ service_status }}</span>
                                    </div>
                                    <small class="text-muted"><i class="bi bi-info-circle"></i> Use sidebar for quick controls</small>
                                </div>
                            </div>
                            <div class="mb-2">
                                <small><b>Memory Usage:</b></small>
                                <span class="text-sm">Service: {{ service_memory_mb }} MB | System: {{ total_memory_mb }}/{{ total_memory_gb }}GB</span>
                                <div class="progress mb-1" style="height:18px;">
                                    <div class="progress-bar {% if ram_percent < 50 %}bg-success{% elif ram_percent < 80 %}bg-warning{% else %}bg-danger{% endif %}" role="progressbar" style="width: {{ ram_percent }}%; font-size:11px;">{{ ram_percent }}%</div>
                                </div>
                            </div>
                            <div class="mb-2">
                                <small><b>CPU Usage:</b></small>
                                <span class="text-sm">Service: {{ service_cpu_percent }}% | System: {{ total_cpu_percent }}%</span>
                                <div class="progress mb-1" style="height:18px;">
                                    <div class="progress-bar {% if total_cpu_percent < 50 %}bg-success{% elif total_cpu_percent < 80 %}bg-warning{% else %}bg-danger{% endif %}" role="progressbar" style="width: {{ total_cpu_percent }}%; font-size:11px;">{{ total_cpu_percent }}%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
            </div>
            
            <!-- File Organization Statistics -->
            <!-- Duplicate Files Detection -->
            <div class="dashboard-module wide" data-module="duplicates" draggable="true">
                    <div class="card">
                    <div class="card-header d-flex align-items-center">
                        <b><i class="bi bi-files"></i> Duplicate Files</b>
                        <span id="badge-duplicates-state" class="badge bg-secondary ms-2">Unknown</span>
                        <a href="/docs/duplicate-detection" target="_blank" class="ms-2 text-decoration-none" title="Open documentation">
                            <small><i class="bi bi-book"></i> Docs</small>
                        </a>
                        <span class="hide-toggle" onclick="toggleHideModule('duplicates')" title="Hide module"><i class="bi bi-x-circle"></i></span>
                        <span class="drag-handle ms-auto"><i class="bi bi-grip-vertical"></i></span>
                    </div>
                    <div id="duplicates-disabled-banner" class="alert alert-warning m-3 d-none" role="alert">
                        <i class="bi bi-slash-circle"></i> Duplicates feature is disabled. Enable it in Features & Integrations.
                    </div>
                    <div class="card-body" id="duplicates-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <span class="badge bg-warning" id="duplicates-count">0 duplicate groups</span>
                                <span class="badge bg-danger" id="wasted-space">0 B wasted</span>
                                <span class="badge bg-info" id="watched-folders-badge" title="Watched folders">watching 0</span>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="loadDuplicates()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                        
                        <div id="duplicates-container">
                            <div class="text-center text-muted">
                                <i class="bi bi-hourglass-split fs-1"></i>
                                <p>Loading duplicates...</p>
                            </div>
                        </div>
                        <div class="mt-2" id="watched-folders-list" style="display:none">
                            <small class="text-muted">Watched folders:</small>
                            <ul class="mb-0" id="watched-folders-ul"></ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- File Organization Statistics -->
            <div class="dashboard-module wide" data-module="statistics" draggable="true">
                <div class="card">
                    <div class="card-header d-flex align-items-center">
                        <b><i class="bi bi-graph-up"></i> File Organization Statistics</b>
                        <span id="badge-reports-state" class="badge bg-secondary ms-2">Unknown</span>
                        <span class="hide-toggle" onclick="toggleHideModule('statistics')" title="Hide module"><i class="bi bi-x-circle"></i></span>
                        <span class="drag-handle ms-auto"><i class="bi bi-grip-vertical"></i></span>
                    </div>
                    <div id="reports-disabled-banner" class="alert alert-warning m-3 d-none" role="alert">
                        <i class="bi bi-slash-circle"></i> Reports feature is disabled. Enable it in Features & Integrations.
                    </div>
                    <div class="card-body" id="statistics-body">
                        <!-- Overview Stats -->
                        <div class="row mb-3">
                            <div class="col-md-2 col-6 text-center">
                                <div class="card bg-primary text-white">
                                    <div class="card-body p-2">
                                        <h4 class="mb-0" id="stat-total-files">0</h4>
                                        <small>Total Files</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 col-6 text-center">
                                <div class="card bg-success text-white">
                                    <div class="card-body p-2">
                                        <h4 class="mb-0" id="stat-today">0</h4>
                                        <small>Today</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 col-6 text-center">
                                <div class="card bg-info text-white">
                                    <div class="card-body p-2">
                                        <h4 class="mb-0" id="stat-week">0</h4>
                                        <small>This Week</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 col-6 text-center">
                                <div class="card bg-warning text-white">
                                    <div class="card-body p-2">
                                        <h4 class="mb-0" id="stat-month">0</h4>
                                        <small>This Month</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 col-6 text-center">
                                <div class="card bg-secondary text-white">
                                    <div class="card-body p-2">
                                        <h4 class="mb-0" id="stat-categories">0</h4>
                                        <small>Categories</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 col-6 text-center">
                                <div class="card bg-dark text-white">
                                    <div class="card-body p-2">
                                        <h4 class="mb-0" id="stat-avg-day">0</h4>
                                        <small>Avg/Day</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Charts Row -->
                        <div class="row">
                            <div class="col-lg-6 mb-3">
                                <h6>Files by Category</h6>
                                <canvas id="chart-category" height="200"></canvas>
                            </div>
                            <div class="col-lg-6 mb-3">
                                <h6>Top 10 File Extensions</h6>
                                <canvas id="chart-extensions" height="200"></canvas>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12 mb-3">
                                <h6>Activity Timeline (Last 30 Days)</h6>
                                <canvas id="chart-timeline" height="80"></canvas>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-12">
                                <h6>Activity by Hour of Day</h6>
                                <canvas id="chart-hourly" height="80"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-12 col-xl-6 dashboard-module" data-module="task-manager" draggable="true">
                    <!-- Task Manager Card -->
                    <div class="card mb-3">
                        <div class="card-header d-flex align-items-center">
                            <b>Task Manager (Top 5 by CPU)</b>
                            <span class="drag-handle ms-auto"><i class="bi bi-grip-vertical"></i></span>
                        </div>
                        <div class="card-body p-2">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th><small>PID</small></th>
                                        <th><small>Name</small></th>
                                        <th><small>CPU %</small></th>
                                        <th><small>RAM MB</small></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for proc in top_processes %}
                                    <tr>
                                        <td><small>{{ proc.pid }}</small></td>
                                        <td><small>{{ proc.name }}</small></td>
                                        <td><small>{{ proc.cpu|round(1) }}</small></td>
                                        <td><small>{{ proc.mem }}</small></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
            </div>
                    
            <div class="dashboard-module wide" data-module="recent-files" draggable="true">
                    <!-- Recent Files Card -->
                    <div class="card mb-3">
                        <div class="card-header d-flex align-items-center">
                            <b>Recent File Movements</b>
                            <a href="/docs/recent-files" target="_blank" class="ms-2 text-decoration-none" title="Open documentation">
                                <small><i class="bi bi-book"></i> Docs</small>
                            </a>
                            <span class="drag-handle ms-auto"><i class="bi bi-grip-vertical"></i></span>
                        </div>
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-end mb-1">
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshRecentFiles()">
                                <i class="bi bi-arrow-clockwise"></i> Refresh
                            </button>
                        </div>
                        <div id="recent-files-list" class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Time</th>
                                        <th>Filename</th>
                                        <th>Category</th>
                                        <th>Actions</th>
                                        <th style="width:50px"></th>
                                    </tr>
                                </thead>
                                <tbody id="recent-files-tbody">
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">Loading recent files...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- Drive Space -->
            <div class="dashboard-module" data-module="drive-space" draggable="true">
                    <div class="card">
                        <div class="card-header d-flex align-items-center">
                            <b>Drive Space</b>
                            <span class="hide-toggle" onclick="toggleHideModule('drive-space')" title="Hide module"><i class="bi bi-x-circle"></i></span>
                            <span class="drag-handle ms-auto"><i class="bi bi-grip-vertical"></i></span>
                        </div>
                        <div class="card-body p-2">
                            <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Device</th>
                                    <th>Total</th>
                                    <th>Used</th>
                                    <th>Usage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for drive in drives %}
                                <tr>
                                    <td>{{ drive.device }}</td>
                                    <td><small>{{ drive.total }}</small></td>
                                    <td><small>{{ drive.used }}</small></td>
                                    <td>
                                        <div class="progress" style="min-width: 50px;">
                                            <div class="progress-bar {% if drive.percent < 50 %}bg-success{% elif drive.percent < 80 %}bg-warning{% else %}bg-danger{% endif %}" role="progressbar" style="width: {{ drive.percent }}%; font-size:11px;">{{ drive.percent }}%</div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        </div>
                    </div>
            </div>
                    
            <!-- Settings -->
            <div class="dashboard-module" data-module="settings" draggable="true">
                    <div class="card">
                        <div class="card-header d-flex align-items-center">
                            <b>Settings</b>
                            <span class="hide-toggle" onclick="toggleHideModule('settings')" title="Hide module"><i class="bi bi-x-circle"></i></span>
                            <span class="drag-handle ms-auto"><i class="bi bi-grip-vertical"></i></span>
                        </div>
                        <div class="card-body p-2">
                        <form id="config-form-settings">
                            <div class="row mb-2">
                                <div class="col-md-12">
                                    <label class="form-label" style="font-size: 0.85rem;"><b>Watch Folder</b></label>
                                    <input class="form-control form-control-sm" type="text" name="watch_folder" value="{{ watch_folder }}" placeholder="e.g., C:\Users\YourName\Downloads">
                                    <small class="form-text text-muted">The folder to monitor for new files. Leave empty to use the default Downloads folder.</small>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label" style="font-size: 0.85rem;"><b>Memory Threshold (MB)</b></label>
                                    <input class="form-control form-control-sm" type="number" name="memory_threshold" value="{{ memory_threshold }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label" style="font-size: 0.85rem;"><b>CPU Threshold (%)</b></label>
                                    <input class="form-control form-control-sm" type="number" name="cpu_threshold" value="{{ cpu_threshold }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label" style="font-size: 0.85rem;"><b>Logs Directory</b></label>
                                    <input class="form-control form-control-sm" type="text" name="logs_dir" value="{{ logs_dir }}">
                                </div>
                            </div>
                            <div class="alert alert-warning alert-sm mt-2 mb-2 py-1 px-2" role="alert" style="font-size: 0.85rem;">
                                <i class="bi bi-exclamation-triangle"></i> <strong>Important:</strong> Changing the watch folder requires restarting the Organizer service.
                            </div>
                            <button class="btn btn-primary btn-sm mt-2" type="button" onclick="saveSettings()">Save Settings</button>
                        </form>
                        </div>
                    </div>
            </div>
                
            <!-- File Categories -->
            <div class="dashboard-module" data-module="file-categories" draggable="true">
                    <div class="card">
                        <div class="card-header d-flex align-items-center">
                            <b>File Categories</b>
                            <span class="hide-toggle" onclick="toggleHideModule('file-categories')" title="Hide module"><i class="bi bi-x-circle"></i></span>
                            <span class="drag-handle ms-auto"><i class="bi bi-grip-vertical"></i></span>
                        </div>
                        <div class="card-body p-2">
                            <div class="alert alert-info alert-sm mb-2 py-1 px-2" role="alert" style="font-size: 0.85rem;">
                                <i class="bi bi-info-circle"></i> <strong>Note:</strong> Changes to file categories and custom routes require restarting the Organizer service to take effect.
                            </div>
                            <form id="config-form">
                            <table class="table table-sm mb-3">
                                <thead>
                                    <tr>
                                        <th>Folder</th>
                                        <th>Extensions (comma-separated)</th>
                                        <th style="width: 80px;">Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- ...existing file categories rows... -->
                                    <!-- Images -->
                                    <tr>
                                        <td><input class="form-control form-control-sm" type="text" name="folder_1" value="Images"></td>
                                        <td>
                                            <input class="form-control form-control-sm" type="text" name="exts_1" value="jpg, jpeg, png, gif, bmp, tiff, svg, webp, heic, ico, raw, psd, ai, eps">
                                        </td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" type="button" onclick="deleteRow(this)">Delete</button>
                                        </td>
                                    </tr>
                                    <!-- ...other categories as before... -->
                                    <!-- Music -->
                                    <tr>
                                        <td><input class="form-control form-control-sm" type="text" name="folder_2" value="Music"></td>
                                        <td>
                                            <input class="form-control form-control-sm" type="text" name="exts_2" value="mp3, wav, flac, aac, ogg, wma, m4a, alac, aiff, opus, amr, mid, midi">
                                        </td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" type="button" onclick="deleteRow(this)">Delete</button>
                                        </td>
                                    </tr>
                                    <!-- Videos -->
                                    <tr>
                                        <td><input class="form-control form-control-sm" type="text" name="folder_3" value="Videos"></td>
                                        <td>
                                            <input class="form-control form-control-sm" type="text" name="exts_3" value="mp4, mkv, avi, mov, wmv, flv, webm, mpeg, mpg, m4v, 3gp, vob, ogv, ts, mts, m2ts">
                                        </td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" type="button" onclick="deleteRow(this)">Delete</button>
                                        </td>
                                    </tr>
                                    <!-- Documents -->
                                    <tr>
                                        <td><input class="form-control form-control-sm" type="text" name="folder_4" value="Documents"></td>
                                        <td>
                                            <input class="form-control form-control-sm" type="text" name="exts_4" value="pdf, doc, docx, txt, rtf, odt, xls, xlsx, ppt, pptx, csv, md, tex, epub, mobi, pages, numbers, key">
                                        </td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" type="button" onclick="deleteRow(this)">Delete</button>
                                        </td>
                                    </tr>
                                    <!-- Archives -->
                                    <tr>
                                        <td><input class="form-control form-control-sm" type="text" name="folder_5" value="Archives"></td>
                                        <td>
                                            <input class="form-control form-control-sm" type="text" name="exts_5" value="zip, rar, 7z, tar, gz, bz2, xz, iso, cab, arj, lzh, ace, uue, jar, tar.gz, tar.bz2">
                                        </td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" type="button" onclick="deleteRow(this)">Delete</button>
                                        </td>
                                    </tr>
                                    <!-- Executables -->
                                    <tr>
                                        <td><input class="form-control form-control-sm" type="text" name="folder_6" value="Executables"></td>
                                        <td>
                                            <input class="form-control form-control-sm" type="text" name="exts_6" value="exe, msi, bat, cmd, ps1, sh, app, deb, rpm, apk, com, bin, run">
                                        </td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" type="button" onclick="deleteRow(this)">Delete</button>
                                        </td>
                                    </tr>
                                    <!-- Shortcuts -->
                                    <tr>
                                        <td><input class="form-control form-control-sm" type="text" name="folder_7" value="Shortcuts"></td>
                                        <td>
                                            <input class="form-control form-control-sm" type="text" name="exts_7" value="lnk, url, desktop, webloc">
                                        </td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" type="button" onclick="deleteRow(this)">Delete</button>
                                        </td>
                                    </tr>
                                    <!-- Scripts -->
                                    <tr>
                                        <td><input class="form-control form-control-sm" type="text" name="folder_8" value="Scripts"></td>
                                        <td>
                                            <input class="form-control form-control-sm" type="text" name="exts_8" value="py, js, html, css, json, xml, sh, ts, php, rb, pl, swift, go, c, cpp, cs, java, scala, lua, r, ipynb, jsx, tsx">
                                        </td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" type="button" onclick="deleteRow(this)">Delete</button>
                                        </td>
                                    </tr>
                                    <!-- Fonts -->
                                    <tr>
                                        <td><input class="form-control form-control-sm" type="text" name="folder_9" value="Fonts"></td>
                                        <td>
                                            <input class="form-control form-control-sm" type="text" name="exts_9" value="ttf, otf, woff, woff2, fon, fnt, eot, svg">
                                        </td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" type="button" onclick="deleteRow(this)">Delete</button>
                                        </td>
                                    </tr>
                                    <!-- Logs -->
                                    <tr>
                                        <td><input class="form-control form-control-sm" type="text" name="folder_10" value="Logs"></td>
                                        <td>
                                            <input class="form-control form-control-sm" type="text" name="exts_10" value="log, out, err">
                                        </td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" type="button" onclick="deleteRow(this)">Delete</button>
                                        </td>
                                    </tr>
                                    <!-- Other -->
                                    <tr>
                                        <td><input class="form-control form-control-sm" type="text" name="folder_11" value="Other"></td>
                                        <td>
                                            <input class="form-control form-control-sm" type="text" name="exts_11" value="">
                                        </td>
                                        <td>
                                            <button class="btn btn-danger btn-sm" type="button" onclick="deleteRow(this)">Delete</button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="d-flex gap-2 mt-2">
                                <button class="btn btn-success btn-sm" type="button" onclick="addCategoryRow()">Add Category</button>
                                <button class="btn btn-primary btn-sm" type="button" onclick="saveConfiguration()">Save Configuration</button>
                            </div>
                        </form>
                        </div>
                    </div>
            </div>
            
            <!-- Custom Routes -->
            <div class="dashboard-module" data-module="custom-routes" draggable="true">
                    <div class="card">
                        <div class="card-header d-flex align-items-center">
                            <b>Custom Routes (Per-Extension)</b>
                            <span class="hide-toggle" onclick="toggleHideModule('custom-routes')" title="Hide module"><i class="bi bi-x-circle"></i></span>
                            <span class="drag-handle ms-auto"><i class="bi bi-grip-vertical"></i></span>
                        </div>
                        <div class="card-body p-2">
                            <!-- Column widths are now resizable by dragging table headers. Sliders removed. -->
                            <form id="custom-routes-form">
                            <table class="table table-sm mb-3" style="table-layout: fixed;" id="custom-routes-table">
                                <thead>
                                    <tr>
                                        <th id="cr-ext-col" style="width: 25%">Extension</th>
                                        <th id="cr-folder-col" style="width: 55%">Target Folder</th>
                                        <th id="cr-action-col" style="width: 20%">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="custom-routes-tbody">
                                    <!-- Rows will be populated dynamically from config or added by user -->
                                </tbody>
                            </table>
                            <div class="d-flex gap-2 mt-2">
                                <button class="btn btn-success btn-sm" type="button" onclick="addCustomRouteRow()">Add Route</button>
                                <button class="btn btn-primary btn-sm" type="button" onclick="saveConfiguration()">Save Configuration</button>
                            </div>
                        </form>
                        <small class="text-muted">Custom routes take precedence over category routing.</small>
                        </div>
                    </div>
            </div>
                
            <!-- Tag Routes -->
            <div class="dashboard-module" data-module="tag-routes" draggable="true">
                    <div class="card">
                        <div class="card-header d-flex align-items-center">
                            <b>Tag Routes (Filename-Based Routing)</b>
                            <span class="hide-toggle" onclick="toggleHideModule('tag-routes')" title="Hide module"><i class="bi bi-x-circle"></i></span>
                            <span class="drag-handle ms-auto"><i class="bi bi-grip-vertical"></i></span>
                        </div>
                        <div class="card-body p-2">
                            <!-- Column widths are now resizable by dragging table headers. Sliders removed. -->
                            <div class="alert alert-info alert-sm mb-2 py-1 px-2" role="alert" style="font-size: 0.85rem;">
                                <i class="bi bi-info-circle"></i> <strong>Tip:</strong> Files containing the tag anywhere in the filename will be moved to the specified folder, regardless of extension. Tag routes have the highest priority.
                            </div>
                            <form id="tag-routes-form">
                            <table class="table table-sm mb-3" style="table-layout: fixed;" id="tag-routes-table">
                                <thead>
                                    <tr>
                                        <th id="tr-tag-col" style="width: 25%">Tag/Keyword</th>
                                        <th id="tr-folder-col" style="width: 55%">Target Folder (absolute path)</th>
                                        <th id="tr-action-col" style="width: 20%">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="tag-routes-tbody">
                                    <!-- Rows will be populated dynamically from config or added by user -->
                                </tbody>
                            </table>
                            <div class="d-flex gap-2 mt-2">
                                <button class="btn btn-success btn-sm" type="button" onclick="addTagRouteRow()">Add Tag Route</button>
                                <button class="btn btn-primary btn-sm" type="button" onclick="saveConfiguration()">Save Configuration</button>
                            </div>
                        </form>
                        <small class="text-muted">Examples: "invoice" → Invoices folder, "screenshot" → Screenshots</small>
                        </div>
                    </div>
            </div>
            
            <!-- Custom widgets will be added dynamically -->
            <div id="custom-widgets-container">
                <!-- Widgets inserted here by JS -->
            </div>
            
        </div>
        </div>
    </div>
        <!-- VirusTotal Modal -->
        <div class="modal fade" id="vtModal" tabindex="-1" aria-labelledby="vtModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="vtModalLabel">VirusTotal Scan Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div id="vtModalBody">
                            <div class="text-muted">No data</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <a id="vtReportLink" href="#" target="_blank" class="btn btn-outline-secondary">Open VT Report</a>
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    <!-- Login / Change-password Modal and scripts -->
    {% include "dashboard_scripts.html" %}
{% endblock %}
