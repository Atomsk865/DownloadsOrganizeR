{% extends "dashboard_base.html" %}
{% block dashboard_content %}
<div class="container mt-3 config-module" style="max-width: 900px;">
  <div class="card">
    <div class="card-header"><b>Initial Dashboard Setup</b></div>
    <div class="card-body p-3">
      <p class="text-muted"><small>Welcome! Complete this one-time setup to secure and configure your dashboard. After completion you will be redirected to the main dashboard and this wizard will be disabled.</small></p>
      <form id="setup-form" onsubmit="return false;">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label mb-1"><small><b>Admin Username</b></small></label>
            <input class="form-control form-control-sm" id="admin-username" placeholder="admin" value="admin" required>
          </div>
          <div class="col-md-6">
            <label class="form-label mb-1 d-flex align-items-center justify-content-between">
              <small><b>Admin Password</b></small>
              <div class="d-flex align-items-center gap-2">
                <a href="/docs/authentication" target="_blank" class="text-decoration-none"><small><i class="bi bi-book"></i> Docs</small></a>
                <span class="badge bg-secondary rounded-circle ms-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Password must be at least 12 characters and include uppercase, lowercase, a digit, and a special character." style="width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;font-size:12px;">i</span>
              </div>
            </label>
            <div class="input-group input-group-sm">
              <input type="password" class="form-control" id="admin-password" placeholder="Strong password" required oninput="evaluatePassword()">
              <button class="btn btn-outline-secondary" type="button" id="toggle-password" onclick="togglePasswordVisibility()" title="Show/Hide" data-bs-toggle="tooltip" data-bs-placement="top">
                <span id="toggle-password-icon" aria-hidden="true">üëÅÔ∏è</span>
              </button>
              <button class="btn btn-outline-success" type="button" id="generate-password" onclick="generateStrongPassword()" title="Generate a strong password" data-bs-toggle="tooltip" data-bs-placement="top">
                Generate
              </button>
            </div>
            <div class="progress mt-1" style="height:6px;">
              <div id="pw-strength-bar" class="progress-bar bg-danger" style="width:5%"></div>
            </div>
            <small id="pw-feedback" class="text-muted"></small>
          </div>
        </div>
        <hr/>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label mb-1"><small><b>Authentication Method</b></small></label>
            <select class="form-select form-select-sm" id="auth-method" onchange="toggleAuthSections()">
              {% for m in available_methods %}
                <option value="{{ m }}">{{ m|capitalize }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label mb-1"><small><b>Enable Fallback (Basic)</b></small></label>
            <select class="form-select form-select-sm" id="fallback-enabled">
              <option value="true" selected>Yes</option>
              <option value="false">No</option>
            </select>
          </div>
        </div>
        <hr/>
        <!-- Optional Integrations & Features -->
        <div id="features-section" class="mt-2">
          <div class="border rounded p-2">
            <div class="mb-2 d-flex align-items-center justify-content-between">
              <small><b>Optional Integrations & Feature Toggles</b></small>
              <small class="text-muted">Configure non-essential features and API keys</small>
            </div>
            <div class="row g-2">
              <div class="col-md-8">
                <label class="form-label mb-1"><small><b>VirusTotal API Key</b> (optional)</small></label>
                <input class="form-control form-control-sm" id="vt-api-key" placeholder="Paste your VirusTotal API key" value="{{ vt_api_key }}">
                <small class="text-muted">Used for hash lookups in Recent Files. If empty, VT features are disabled.</small>
              </div>
              <div class="col-md-4">
                <label class="form-label mb-1"><small><b>Feature Toggles</b></small></label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="feat-virustotal" {% if features.virustotal_enabled %}checked{% endif %}>
                  <label class="form-check-label"><small>Enable VirusTotal integration</small></label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="feat-duplicates" {% if features.duplicates_enabled %}checked{% endif %}>
                  <label class="form-check-label"><small>Enable Duplicate Detection</small></label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="feat-reports" {% if features.reports_enabled %}checked{% endif %}>
                  <label class="form-check-label"><small>Enable Reports & Analytics</small></label>
                </div>
              </div>
            </div>
          </div>
        </div>
        <hr/>
        <!-- Recommended Watch Folders -->
        <div id="watch-folders-section" class="mt-2">
          <div class="border rounded p-2">
            <div class="mb-2 d-flex align-items-center justify-content-between">
              <small><b>Recommended Watch Folders</b></small>
              <small class="text-muted">Detected host OS: {{ host_os|capitalize }} ‚Äî select folders to monitor</small>
            </div>
            <div class="row g-2">
              <div class="col-12">
                <!-- Show both OS options to avoid container/codespace mismatch -->
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="wf-win-downloads" value="C:/Users/%USERNAME%/Downloads">
                  <label class="form-check-label" for="wf-win-downloads"><small>Windows Downloads (`C:/Users/%USERNAME%/Downloads`)</small></label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="wf-linux-downloads" value="/home/%USER%/Downloads">
                  <label class="form-check-label" for="wf-linux-downloads"><small>Linux Downloads (`/home/%USER%/Downloads`)</small></label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="wf-shared-incoming" value="/mnt/shared/incoming">
                  <label class="form-check-label" for="wf-shared-incoming"><small>Shared Incoming (`/mnt/shared/incoming`)</small></label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="wf-custom-enable">
                  <label class="form-check-label" for="wf-custom-enable"><small>Add a custom folder</small></label>
                </div>
                <div class="input-group input-group-sm mt-1">
                  <input type="text" class="form-control" id="wf-custom-path" placeholder="Enter path (e.g., C:/Incoming or /data/downloads)" disabled value="{{ default_download_path }}">
                  <button class="btn btn-outline-secondary" type="button" onclick="addCustomWatchFolder()" id="wf-custom-add" disabled>Add</button>
                  <button class="btn btn-outline-info" type="button" onclick="prefillDefaultDownload()" id="wf-custom-prefill" disabled>Use Default</button>
                  <button class="btn btn-outline-success" type="button" onclick="addDefaultToSelection()" id="wf-custom-add-default" disabled>Add Default to Selection</button>
                </div>
                <div class="mt-1">
                  <small class="text-muted">Default detected: <code id="wf-default-hint">{{ default_download_path }}</code></small>
                </div>
                <div class="mt-2">
                  <small class="text-muted">You can change these anytime in Configuration ‚Üí Watched Folders.</small>
                </div>
                <div id="wf-selected" class="mt-2"></div>
              </div>
            </div>
          </div>
        </div>
        <!-- LDAP Section -->
        <div id="ldap-section" class="mt-3" style="display:none;">
          <div class="border rounded p-2">
            <div class="mb-2"><small><b>LDAP / Active Directory Settings</b></small></div>
            <div class="row g-2">
              <div class="col-md-6">
                <input class="form-control form-control-sm" id="ldap-server" placeholder="ldap://server:389">
              </div>
              <div class="col-md-6">
                <input class="form-control form-control-sm" id="ldap-base-dn" placeholder="dc=example,dc=com">
              </div>
              <div class="col-md-6">
                <input class="form-control form-control-sm" id="ldap-user-template" placeholder="uid={username},{base_dn}" value="uid={username},{base_dn}">
              </div>
              <div class="col-md-6">
                <input class="form-control form-control-sm" id="ldap-search-filter" placeholder="(uid={username})" value="(uid={username})">
              </div>
              <div class="col-md-6">
                <input class="form-control form-control-sm" id="ldap-bind-dn" placeholder="Service bind DN (optional)">
              </div>
              <div class="col-md-6">
                <input type="password" class="form-control form-control-sm" id="ldap-bind-password" placeholder="Bind password (optional)">
              </div>
              <div class="col-md-6">
                <input class="form-control form-control-sm" id="ldap-allowed-groups" placeholder="Group DNs (comma separated)">
              </div>
              <div class="col-md-6 form-check ms-2">
                <input class="form-check-input" type="checkbox" id="ldap-use-ssl" checked>
                <label class="form-check-label"><small>Use SSL/TLS</small></label>
              </div>
            </div>
          </div>
        </div>
        <!-- Windows Auth Section -->
        <div id="windows-section" class="mt-3" style="display:none;">
          <div class="border rounded p-2">
            <div class="mb-2"><small><b>Windows Authentication Settings</b></small></div>
            <div class="row g-2">
              <div class="col-md-6">
                <input class="form-control form-control-sm" id="win-domain" placeholder="DOMAIN (optional)">
              </div>
              <div class="col-md-6">
                <input class="form-control form-control-sm" id="win-allowed-groups" placeholder="Group names (comma separated)">
              </div>
            </div>
          </div>
        </div>
        <hr/>
        <!-- Complete Setup Button at Bottom -->
        <div class="row g-3">
          <div class="col-12">
            <div class="d-flex w-100 align-items-center gap-2">
              <button type="button" class="btn btn-primary flex-grow-1" onclick="submitSetup()">Complete Setup</button>
              <a href="/docs/readme" target="_blank" class="btn btn-outline-dark"><i class="bi bi-book"></i> Docs</a>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
<script>
function toggleAuthSections(){
  const method = document.getElementById('auth-method').value;
  document.getElementById('ldap-section').style.display = method === 'ldap' ? 'block' : 'none';
  document.getElementById('windows-section').style.display = method === 'windows' ? 'block' : 'none';
}
function evaluatePassword(){
  const pw = document.getElementById('admin-password').value;
  let score = 0;
  if(pw.length >= 12) score += 25;
  if(/[A-Z]/.test(pw)) score += 15;
  if(/[a-z]/.test(pw)) score += 15;
  if(/\d/.test(pw)) score += 15;
  if(/[^A-Za-z0-9]/.test(pw)) score += 30;
  const bar = document.getElementById('pw-strength-bar');
  bar.style.width = Math.min(score,100) + '%';
  bar.className = 'progress-bar ' + (score<40?'bg-danger':score<70?'bg-warning':'bg-success');
  const fb = document.getElementById('pw-feedback');
  fb.textContent = score<40?'Weak password':score<70?'Moderate password':'Strong password';
}
function togglePasswordVisibility(){
  const input = document.getElementById('admin-password');
  const icon = document.getElementById('toggle-password-icon');
  const isPassword = input.type === 'password';
  input.type = isPassword ? 'text' : 'password';
  icon.textContent = isPassword ? 'üôà' : 'üëÅÔ∏è';
}
function generateStrongPassword(){
  // Generates a 20-char password with upper, lower, digits, specials
  const upper = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  const lower = 'abcdefghijklmnopqrstuvwxyz';
  const digits = '0123456789';
  const specials = '!@#$%^&*()-_=+[]{};:,.<>/?';
  const all = upper + lower + digits + specials;
  function pick(str){ return str[Math.floor(Math.random()*str.length)]; }
  let pw = [pick(upper), pick(lower), pick(digits), pick(specials)];
  for(let i=0; i<16; i++){ pw.push(pick(all)); }
  // Shuffle
  for(let i=pw.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [pw[i],pw[j]]=[pw[j],pw[i]]; }
  const val = pw.join('');
  const input = document.getElementById('admin-password');
  input.value = val;
  evaluatePassword();
}
function submitSetup(){
  const adminUsername = document.getElementById('admin-username').value.trim();
  const adminPassword = document.getElementById('admin-password').value;
  const authMethod = document.getElementById('auth-method').value;
  const fallbackEnabled = document.getElementById('fallback-enabled').value === 'true';
  if(!adminUsername || !adminPassword){
    showNotification('Admin username and password required', 'danger');
    return;
  }
  // Basic client-side validation mirroring server rules
  const unameRegex = /^[A-Za-z0-9_-]{3,32}$/;
  if(!unameRegex.test(adminUsername)){
    showNotification('Username must be 3-32 chars (letters, numbers, _ -)', 'danger'); return;
  }
  const pwIssues = [];
  if(adminPassword.length < 12) pwIssues.push('>=12 chars');
  if(!/[A-Z]/.test(adminPassword)) pwIssues.push('uppercase');
  if(!/[a-z]/.test(adminPassword)) pwIssues.push('lowercase');
  if(!/\d/.test(adminPassword)) pwIssues.push('digit');
  if(!/[^A-Za-z0-9]/.test(adminPassword)) pwIssues.push('special');
  if(pwIssues.length){
    showNotification('Password needs: ' + pwIssues.join(', '), 'danger'); return;
  }
  const payload = {
    admin_username: adminUsername,
    admin_password: adminPassword,
    auth_method: authMethod,
    auth_fallback_enabled: fallbackEnabled
  };
  if(authMethod === 'ldap'){
    payload.server = document.getElementById('ldap-server').value.trim();
    payload.base_dn = document.getElementById('ldap-base-dn').value.trim();
    payload.user_dn_template = document.getElementById('ldap-user-template').value.trim();
    payload.search_filter = document.getElementById('ldap-search-filter').value.trim();
    payload.bind_dn = document.getElementById('ldap-bind-dn').value.trim();
    payload.bind_password = document.getElementById('ldap-bind-password').value;
    payload.allowed_groups = document.getElementById('ldap-allowed-groups').value.split(',').map(s=>s.trim()).filter(Boolean);
    payload.use_ssl = document.getElementById('ldap-use-ssl').checked;
    if(!payload.server || !payload.base_dn){
      showNotification('LDAP server and base DN are required', 'danger'); return;
    }
  }
  if(authMethod === 'windows'){
    payload.domain = document.getElementById('win-domain').value.trim();
    payload.allowed_groups = document.getElementById('win-allowed-groups').value.split(',').map(s=>s.trim()).filter(Boolean);
  }
  showNotification('Applying setup...', 'info');
  fetch('/api/setup/initialize', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)})
    .then(async r => {
      const text = await r.text();
      try {
        const json = JSON.parse(text);
        return {ok: r.ok, j: json};
      } catch (e) {
        console.error('Response not JSON:', text);
        return {ok: false, j: {error: 'Server returned invalid response: ' + text.substring(0, 200)}};
      }
    })
    .then(async ({ok,j})=>{
      if(ok && j.success){
        // Persist selected watch folders
        const selected = getSelectedWatchFolders();
        const vtApiKey = document.getElementById('vt-api-key').value.trim();
        const features = {
          virustotal_enabled: document.getElementById('feat-virustotal').checked,
          duplicates_enabled: document.getElementById('feat-duplicates').checked,
          reports_enabled: document.getElementById('feat-reports').checked
        };
        try{
          const r2 = await fetch('/api/setup/save', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ watch_folders: selected, vt_api_key: vtApiKey, features })
          });
          if(r2.ok){
            showNotification('Setup preferences saved', 'success');
          } else {
            const err2 = await r2.json().catch(()=>({}));
            showNotification('Failed to save setup preferences: ' + (err2.message||r2.status), 'warning');
          }
        } catch(e){
          showNotification('Error saving setup preferences: ' + e.message, 'warning');
        }
        showNotification('Setup complete! Redirecting to login...', 'success');
        setTimeout(()=>{ window.location.href='/login'; },1500);
      } else {
        showNotification(j.error||'Setup failed','danger');
      }
    })
    .catch(err=> showNotification('Setup error: '+ err.message, 'danger'));
}
// Minimal notification helper fallback if dashboard_scripts not loaded yet
function showNotification(msg, type){
  let alert = document.createElement('div');
  alert.className = 'alert alert-' + (type||'info') + ' alert-dismissible fade show';
  alert.role = 'alert';
  alert.innerHTML = '<small>' + msg + '</small><button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
  const container = document.getElementById('notification-container');
  if (container) {
    container.appendChild(alert);
  } else {
    document.querySelector('.card-body').prepend(alert);
  }
  setTimeout(() => { alert.remove(); }, 5000);
}
// Initialize Bootstrap tooltips if available
document.addEventListener('DOMContentLoaded', function(){
  if(window.bootstrap && typeof bootstrap.Tooltip === 'function'){
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
      new bootstrap.Tooltip(tooltipTriggerEl);
    });
  }
  const customEnable = document.getElementById('wf-custom-enable');
  const customInput = document.getElementById('wf-custom-path');
  const customAdd = document.getElementById('wf-custom-add');
  const prefillBtn = document.getElementById('wf-custom-prefill');
  const addDefaultBtn = document.getElementById('wf-custom-add-default');
  customEnable.addEventListener('change', function(){
    const en = customEnable.checked;
    customInput.disabled = !en;
    customAdd.disabled = !en;
    if(prefillBtn) prefillBtn.disabled = !en;
    if(addDefaultBtn) addDefaultBtn.disabled = !en;
  });
  // Initialize button states on page load
  const initiallyEnabled = customEnable.checked;
  customInput.disabled = !initiallyEnabled;
  customAdd.disabled = !initiallyEnabled;
  if(prefillBtn) prefillBtn.disabled = !initiallyEnabled;
  if(addDefaultBtn) addDefaultBtn.disabled = !initiallyEnabled;
  ['wf-win-downloads','wf-linux-downloads','wf-shared-incoming'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('change', renderSelectedWatchFolders);
  });
  // Auto-select based on server OS recommendations
  try {
    const recommended = {{ recommended_watch_folders|tojson }};
    recommended.forEach(path => {
      if(path.startsWith('C:/')){ const el = document.getElementById('wf-win-downloads'); if(el) el.checked = true; }
      if(path.startsWith('/home/')){ const el = document.getElementById('wf-linux-downloads'); if(el) el.checked = true; }
    });
    // Additionally auto-select based on client user agent
    const ua = (navigator.userAgent || '').toLowerCase();
    if(ua.includes('windows')){ const el = document.getElementById('wf-win-downloads'); if(el) el.checked = true; }
    if(ua.includes('linux')){ const el = document.getElementById('wf-linux-downloads'); if(el) el.checked = true; }
  } catch(e) { /* ignore */ }
  renderSelectedWatchFolders();
});

function prefillDefaultDownload(){
  const input = document.getElementById('wf-custom-path');
  const def = {{ default_download_path|tojson }};
  if(def){ input.value = def; }
}

function addDefaultToSelection(){
  const def = {{ default_download_path|tojson }};
  if(!def){ showNotification('No default path available', 'warning'); return; }
  const input = document.getElementById('wf-custom-path');
  input.value = def;
  addCustomWatchFolder();
}

function getSelectedWatchFolders(){
  const ids = ['wf-win-downloads','wf-linux-downloads','wf-shared-incoming'];
  const selected = ids.map(id=>{
    const el = document.getElementById(id);
    return (el && el.checked) ? el.value : null;
  }).filter(Boolean);
  // Collect custom entries listed in wf-selected list items with data-path
  document.querySelectorAll('#wf-selected li[data-path]').forEach(li=>{
    selected.push(li.getAttribute('data-path'));
  });
  // Deduplicate
  return Array.from(new Set(selected));
}

function renderSelectedWatchFolders(){
  const list = document.getElementById('wf-selected');
  const selected = getSelectedWatchFolders();
  if(!selected.length){
    list.innerHTML = '<small class="text-muted">No folders selected yet.</small>';
    return;
  }
  list.innerHTML = '<small><b>Selected:</b></small>\n<ul class="mt-1 mb-0">' + selected.map(p=>
    `<li data-path="${p}"><code>${p}</code> <button class="btn btn-sm btn-outline-danger ms-1" type="button" onclick="removeSelectedWatchFolder('${p}')">Remove</button></li>`
  ).join('') + '</ul>';
}

function addCustomWatchFolder(){
  const input = document.getElementById('wf-custom-path');
  const val = input.value.trim();
  if(!val){ showNotification('Enter a folder path', 'danger'); return; }
  // Basic validation: must be absolute path
  const isWin = /^[A-Za-z]:\//.test(val);
  const isUnix = val.startsWith('/');
  if(!(isWin||isUnix)){
    showNotification('Please enter an absolute path (e.g., C:/Incoming or /data/downloads)', 'danger');
    return;
  }
  // Add to selected list
  const list = document.getElementById('wf-selected');
  const current = getSelectedWatchFolders();
  if(current.includes(val)){
    showNotification('Folder already selected', 'warning'); return;
  }
  const li = document.createElement('li');
  li.setAttribute('data-path', val);
  li.innerHTML = `<code>${val}</code> <button class="btn btn-sm btn-outline-danger ms-1" type="button" onclick="removeSelectedWatchFolder('${val}')">Remove</button>`;
  const ul = list.querySelector('ul');
  if(ul){ ul.appendChild(li); }
  else {
    list.innerHTML = '<small><b>Selected:</b></small>\n<ul class="mt-1 mb-0"></ul>';
    list.querySelector('ul').appendChild(li);
  }
}

function removeSelectedWatchFolder(path){
  const list = document.getElementById('wf-selected');
  const li = Array.from(list.querySelectorAll('li')).find(el=> el.getAttribute('data-path') === path);
  if(li){ li.remove(); }
  renderSelectedWatchFolders();
}
</script>
{# Removed OS-specific tips for a cleaner setup footer #}
{% endblock %}
