{% extends "dashboard_base.html" %}
{% block dashboard_content %}
<div class="mb-3 d-flex justify-content-between align-items-center">
  <h5 class="mb-0">Dashboard Configuration</h5>
  <div>
    <button class="btn btn-sm btn-danger me-2" onclick="factoryReset()" data-right="manage_config" title="Reset all settings to defaults">
      <i class="bi bi-exclamation-triangle"></i> Factory Reset
    </button>
      <button class="btn btn-sm btn-outline-primary me-2" onclick="resetSetup()" data-right="manage_config" title="Re-run initial setup wizard">
        <i class="bi bi-arrow-counterclockwise"></i> Re-run Setup
      </button>
      <button class="btn btn-sm btn-success me-2" onclick="repairAuth()" data-right="manage_config" title="Align admin credentials across configs">
        <i class="bi bi-shield-lock"></i> Repair Auth
      </button>
      <button class="btn btn-sm btn-outline-info me-2" onclick="viewAuthState()" data-right="manage_config" title="View current auth state">
        <i class="bi bi-info-circle"></i> Auth State
      </button>
    <a href="/" class="btn btn-sm btn-outline-secondary">Back to Dashboard</a>
  </div>
</div>
<div class="row g-3" id="config-root" data-right="manage_config">
  <div class="col-md-5">
    <div class="card">
      <div class="card-header"><b>Users & Roles</b></div>
      <div class="card-body p-2">
        <table class="table table-sm" id="users-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Role</th>
              <th style="width:80px">Actions</th>
            </tr>
          </thead>
          <tbody id="users-tbody"></tbody>
        </table>
        <hr class="mt-2 mb-2"/>
        <div class="mb-2"><b>Add / Update User</b></div>
        <div class="mb-2">
          <input id="new-username" class="form-control form-control-sm" placeholder="Username">
        </div>
        <div class="mb-2">
          <select id="new-role" class="form-select form-select-sm"></select>
        </div>
        <div class="mb-2">
          <input id="new-password" class="form-control form-control-sm" type="password" placeholder="Password (leave blank to keep)">
        </div>
        <button class="btn btn-primary btn-sm" onclick="saveUser()">Save User</button>
      </div>
    </div>
    <div class="card mt-3">
      <div class="card-header"><b>Role Rights</b></div>
      <div class="card-body p-2">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th>Role</th>
              <th>Rights</th>
            </tr>
          </thead>
          <tbody>
            {% for role, rights in roles.items() %}
            <tr>
              <td><small>{{ role }}</small></td>
              <td>
                {% for r, allowed in rights.items() %}
                  <span class="badge bg-{{ 'success' if allowed else 'secondary' }} mb-1">{{ r }}</span>
                {% endfor %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="col-md-7" id="layout-editor" data-right="modify_layout">
      <div class="col-md-7">
        <div class="card mb-3" data-right="manage_service">
          <div class="card-header"><b>Service Installation</b></div>
          <div class="card-body p-2">
            <div class="mb-2">
              <label class="form-label mb-1"><small><b>Service Name</b></small></label>
              <input id="service-name-input" class="form-control form-control-sm" value="DownloadsOrganizer">
            </div>
            <div class="mb-2">
              <label class="form-label mb-1"><small><b>Scripts Root Directory</b></small></label>
              <input id="scripts-root-input" class="form-control form-control-sm" value="C:\Scripts">
            </div>
            <div class="row">
              <div class="col-md-6 mb-2">
                <label class="form-label mb-1"><small><b>Memory Threshold (MB)</b></small></label>
                <input id="memory-threshold-input" type="number" class="form-control form-control-sm" value="200">
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label mb-1"><small><b>CPU Threshold (%)</b></small></label>
                <input id="cpu-threshold-input" type="number" class="form-control form-control-sm" value="60">
              </div>
            </div>
            <div class="d-flex gap-2 mt-2">
              <button class="btn btn-primary btn-sm" onclick="installService()">
                <i class="bi bi-download"></i> Install Service
              </button>
              <button class="btn btn-warning btn-sm" onclick="reinstallService()">
                <i class="bi bi-arrow-repeat"></i> Reinstall
              </button>
              <button class="btn btn-danger btn-sm" onclick="uninstallService()">
                <i class="bi bi-trash"></i> Uninstall Service
              </button>
            </div>
            <div class="mt-2">
              <small class="text-muted">
                <i class="bi bi-info-circle"></i> Service installation requires Windows and administrator privileges.
              </small>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-7" id="layout-editor" data-right="modify_layout">
    <div class="card">
      <div class="card-header"><b>Layout (Drag to Reorder)</b></div>
      <div class="card-body p-2">
        <ul id="sections-list" class="list-group mb-2"></ul>
        <div class="mb-2">
          <small class="text-muted">Check to hide a section. Drag handles on left to reorder.</small>
        </div>
        <button class="btn btn-success btn-sm" onclick="saveLayout()">Save Layout</button>
      </div>
    </div>
  </div>
  <div class="col-md-7">
    <div class="card mt-3" data-right="manage_config">
      <div class="card-header"><b>Network Targets (NAS/SMB)</b></div>
      <div class="card-body p-2">
        <div class="mb-2">
          <label class="form-label mb-1"><small><b>Template</b></small></label>
          <select class="form-select form-select-sm" id="nas-template" onchange="applyNASTemplate()" title="Quick setup for common NAS types">
            <option value="">-- Select a template --</option>
            <option value="synology">Synology NAS</option>
            <option value="qnap">QNAP NAS</option>
            <option value="windows">Windows Share</option>
            <option value="generic">Generic SMB/CIFS</option>
          </select>
        </div>
        <table class="table table-sm" id="network-targets-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>UNC Path</th>
              <th>Credential Key</th>
              <th style="width:80px">Actions</th>
            </tr>
          </thead>
          <tbody id="network-targets-tbody"></tbody>
        </table>
        <hr class="mt-2 mb-2"/>
        <div class="row g-2">
          <div class="col-md-4">
            <input id="nt-name" class="form-control form-control-sm" placeholder="Name" title="Reference name for the network target">
            <div class="invalid-feedback">Name is required.</div>
          </div>
          <div class="col-md-5">
            <input id="nt-path" class="form-control form-control-sm" placeholder="\\\\NAS\\Share\\Downloads" title="UNC path to the NAS/SMB share">
            <div class="invalid-feedback">Provide a valid UNC path, e.g., \\server\\share\\folder</div>
          </div>
          <div class="col-md-3">
            <input id="nt-cred" class="form-control form-control-sm" placeholder="credential_key" title="Key to credentials in config">
            <div class="invalid-feedback">Credential key is required.</div>
          </div>
        </div>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-primary btn-sm" onclick="addNetworkTarget()" title="Add or update network target">Save Target</button>
          <button class="btn btn-info btn-sm" onclick="testNAS()" title="Test selected network target">Test NAS</button>
          <button class="btn btn-success btn-sm" onclick="saveNetworkConfig()" title="Persist network targets and credentials to organizer config">Persist Network Config</button>
        </div>
        <div class="mt-2">
          <small class="text-muted">Credentials are referenced by key. Configure below in SMTP & Credentials.</small>
        </div>
      </div>
    </div>
    <div class="card mt-3" data-right="manage_config">
      <div class="card-header"><b>SMTP & Credentials</b></div>
      <div class="card-body p-2">
        <div class="mb-2">
          <label class="form-label mb-1"><small><b>SMTP Template</b></small></label>
          <select class="form-select form-select-sm" id="smtp-template" onchange="applySMTPTemplate()" title="Quick setup for common email providers">
            <option value="">-- Select a template --</option>
            <option value="gmail">Gmail</option>
            <option value="outlook">Outlook.com</option>
            <option value="office365">Office 365</option>
            <option value="yahoo">Yahoo Mail</option>
            <option value="generic">Generic SMTP</option>
          </select>
        </div>
        <div class="row g-2">
          <div class="col-md-3">
            <input id="smtp-host" class="form-control form-control-sm" placeholder="SMTP Host" title="Mail server hostname">
            <div class="invalid-feedback">SMTP host is required.</div>
          </div>
          <div class="col-md-2">
            <input id="smtp-port" type="number" class="form-control form-control-sm" placeholder="587" title="SMTP port">
            <div class="invalid-feedback">Port must be between 1 and 65535.</div>
          </div>
          <div class="col-md-3">
            <input id="smtp-from" class="form-control form-control-sm" placeholder="from@example.com" title="Sender address">
            <div class="invalid-feedback">Enter a valid email address.</div>
          </div>
          <div class="col-md-4">
            <input id="smtp-to" class="form-control form-control-sm" placeholder="to@example.com" title="Recipient address (comma-separated)">
            <div class="invalid-feedback">Enter one or more valid email addresses.</div>
          </div>
          <div class="col-md-3"><input id="smtp-user" class="form-control form-control-sm" placeholder="Username" title="SMTP username"></div>
          <div class="col-md-3"><input id="smtp-pass" type="password" class="form-control form-control-sm" placeholder="Password" title="SMTP password"></div>
          <div class="col-md-2 form-check d-flex align-items-center ms-2">
            <input class="form-check-input" type="checkbox" id="smtp-tls" checked title="Use STARTTLS">
            <label class="form-check-label ms-1"><small>TLS</small></label>
          </div>
        </div>
        <hr class="mt-2 mb-2"/>
        <div class="mb-2"><b>Stored Credentials</b> <small class="text-muted">(Base64 password; consider OS vault for production)</small></div>
        <table class="table table-sm" id="credentials-table">
          <thead>
            <tr>
              <th>Key</th>
              <th>Username</th>
              <th>Password (base64)</th>
              <th style="width:80px">Actions</th>
            </tr>
          </thead>
          <tbody id="credentials-tbody"></tbody>
        </table>
        <div class="row g-2">
          <div class="col-md-3">
            <input id="cred-key" class="form-control form-control-sm" placeholder="nas_default" title="Credential key">
            <div class="invalid-feedback">Credential key is required.</div>
          </div>
          <div class="col-md-3"><input id="cred-user" class="form-control form-control-sm" placeholder="user" title="Username"></div>
          <div class="col-md-6">
            <input id="cred-pass-b64" class="form-control form-control-sm" placeholder="cGFzc3dvcmQ=" title="Base64-encoded password">
            <div class="invalid-feedback">Password must be base64-encoded.</div>
          </div>
        </div>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-primary btn-sm" onclick="addCredential()" title="Add or update credential">Save Credential</button>
          <button class="btn btn-info btn-sm" onclick="testSMTP()" title="Send a test email">Test SMTP</button>
          <button class="btn btn-success btn-sm" onclick="saveSmtpAndCredentials()" title="Persist SMTP and credentials">Persist SMTP & Credentials</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% include "dashboard_scripts.html" %}
<script>
let dashboardConfig = null;
function fetchConfig() {
  fetch('/api/dashboard/config', {headers: getAuthHeaders()})
    .then(r => { if(!r.ok) throw new Error('Failed'); return r.json(); })
    .then(data => {
      dashboardConfig = data;
      renderUsers(data.users);
      renderRoles(Object.keys(data.roles));
      renderLayout(data.layout);
      renderNetworkTargets(data.network_targets || {});
      renderCredentials(data.credentials || {});
      renderSmtp(data.smtp || {});
    })
    .catch(err => showNotification('Load failed: ' + err.message, 'danger'));
}
function renderUsers(users){
  const tbody = document.getElementById('users-tbody');
  tbody.innerHTML = users.map(u => {
    return `<tr><td><small>${u.username}</small></td><td><small>${u.role}</small></td><td><button class='btn btn-sm btn-danger' onclick="deleteUser('${u.username}')">Del</button></td></tr>`;
  }).join('');
  // Reapply rights after rendering dynamic content
  if (typeof applyConfigRights === 'function') {
    applyConfigRights();
  }
}
function renderRoles(roleNames){
  const sel = document.getElementById('new-role');
  sel.innerHTML = roleNames.map(r => `<option value='${r}'>${r}</option>`).join('');
}
function saveUser(){
  const username = document.getElementById('new-username').value.trim();
  const role = document.getElementById('new-role').value.trim();
  const password = document.getElementById('new-password').value;
  if(!username || !role){ showNotification('Username and role required', 'warning'); return; }
  fetch('/api/dashboard/users', {method:'POST', headers: {'Content-Type':'application/json', ...getAuthHeaders()}, body: JSON.stringify({username, role, password: password || undefined})})
    .then(r=>r.json().then(j=>({ok:r.ok, j})))
    .then(({ok,j})=>{ if(ok){ showNotification('User saved', 'success'); document.getElementById('new-password').value=''; fetchConfig(); } else { showNotification(j.error||'Save failed','danger'); } });
}
function deleteUser(username){
  if(!confirm('Delete user ' + username + '?')) return;
  fetch('/api/dashboard/users/' + encodeURIComponent(username), {method:'DELETE', headers: getAuthHeaders()})
    .then(r=>r.json().then(j=>({ok:r.ok,j})))
    .then(({ok,j})=>{ if(ok){ showNotification('User deleted', 'success'); fetchConfig(); } else { showNotification(j.error||'Delete failed','danger'); } });
}
function renderLayout(layout){
  const list = document.getElementById('sections-list');
  const order = layout.sections_order || [];
  const hidden = new Set(layout.hidden_sections || []);
  list.innerHTML = order.map(sec => {
    const checked = hidden.has(sec) ? 'checked' : '';
    return `<li class='list-group-item d-flex align-items-center' draggable='true' ondragstart='dragStart(event)' ondragover='dragOver(event)' ondrop='dropItem(event)'>
      <span class='me-2 text-muted' style='cursor:grab'>&#9776;</span>
      <input type='checkbox' class='form-check-input me-2' data-section='${sec}' ${checked} />
      <span>${sec}</span>
    </li>`;
  }).join('');
  // Reapply rights after rendering dynamic content
  if (typeof applyConfigRights === 'function') {
    applyConfigRights();
  }
}
let dragSrcEl = null;
function dragStart(e){ dragSrcEl = e.currentTarget; e.dataTransfer.effectAllowed='move'; }
function dragOver(e){ e.preventDefault(); e.dataTransfer.dropEffect='move'; }
function dropItem(e){ e.preventDefault(); const target = e.currentTarget; if(dragSrcEl && dragSrcEl!==target){ const list = target.parentNode; const items=[...list.children]; const srcIndex=items.indexOf(dragSrcEl); const tgtIndex=items.indexOf(target); if(srcIndex < tgtIndex){ list.insertBefore(dragSrcEl, target.nextSibling); } else { list.insertBefore(dragSrcEl, target); } } }
function saveLayout(){
  const items = [...document.querySelectorAll('#sections-list li')];
  const sections_order = items.map(li => li.querySelector('span:last-of-type').textContent.trim());
  const hidden_sections = items.filter(li => li.querySelector('input').checked).map(li => li.querySelector('span:last-of-type').textContent.trim());
  fetch('/api/dashboard/layout', {method:'POST', headers:{'Content-Type':'application/json', ...getAuthHeaders()}, body: JSON.stringify({sections_order, hidden_sections})})
    .then(r=>r.json().then(j=>({ok:r.ok,j})))
    .then(({ok,j})=>{ if(ok){ showNotification('Layout saved','success'); } else { showNotification(j.error||'Layout save failed','danger'); } });
}

// ---- Validation helpers ----
function setInvalid(id, msg){
  const el = document.getElementById(id);
  if(!el) return false;
  el.classList.add('is-invalid');
  const fb = el.parentElement.querySelector('.invalid-feedback');
  if(fb && msg) fb.textContent = msg;
  return false;
}
function clearInvalid(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.classList.remove('is-invalid');
}
function isValidUNC(p){
  // \\server\share or \\server\share\path
  return /^\\\\[^\\\/]+\\[^\\\/]+(\\.*)?$/.test(p || '');
}
function isValidEmail(e){
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((e||'').trim());
}
function validateEmails(list){
  const items = (list||'').split(/[,;]+/).map(s=>s.trim()).filter(Boolean);
  return items.length>0 && items.every(isValidEmail);
}
function isValidBase64(s){
  if(!s) return true; // allow empty
  try { atob(s); return true; } catch(e){ return false; }
}
// Initialize
document.addEventListener('DOMContentLoaded', () => {
  // Restore auth from sessionStorage if not already set
  if (typeof __authHeader === 'undefined' || !__authHeader) {
    try {
      const storedAuth = sessionStorage.getItem('authHeader');
      if (storedAuth) {
        __authHeader = storedAuth;
      }
    } catch (e) {
      console.warn('sessionStorage not available:', e);
    }
  }
  
  // Verify auth and load rights if we have credentials
  if (__authHeader) {
    fetch('/auth_check', {
      credentials: 'include',
      headers: { 'Authorization': __authHeader }
    }).then(response => {
      if (response.ok) {
        return response.json();
      } else {
        throw new Error('Auth check failed');
      }
    }).then(data => {
      __rights = data.rights || {};
      __configVersion = data.config_version || 0;
      applyConfigRights();
      // Fetch config AFTER rights are loaded to avoid race condition
      fetchConfig();
    }).catch(err => {
      console.error('Auth check failed:', err);
      showNotification('Authentication failed. Please login again.', 'danger');
      setTimeout(() => { window.location.href = '/'; }, 2000);
    });
  } else {
    showNotification('Not logged in. Redirecting...', 'warning');
    setTimeout(() => { window.location.href = '/'; }, 2000);
  }
});

// Helper function to safely parse JSON responses
async function parseResponse(response) {
  const contentType = response.headers.get('content-type');
  if (contentType && contentType.includes('application/json')) {
    try {
      const json = await response.json();
      return { ok: response.ok, status: response.status, json };
    } catch (e) {
      return { ok: false, status: response.status, error: 'Invalid JSON response' };
    }
  } else {
    const text = await response.text();
    return { ok: response.ok, status: response.status, text };
  }
}

// Global functions that need to be accessible from onclick handlers
function resetSetup(){
  if(!confirm('Re-run setup wizard? Users will be redirected to setup page and must complete it again to access dashboard.')) return;
  fetch('/api/setup/reset', {method:'POST', headers: getAuthHeaders()})
    .then(r=>r.json().then(j=>({ok:r.ok,j})))
    .then(({ok,j})=>{ if(ok && j.success){ showNotification('Setup reset. Redirecting to wizard...', 'success'); setTimeout(()=>{ window.location.href='/setup'; },1500); } else { showNotification(j.error||'Reset failed','danger'); } });
}

async function installService() {
  if (!confirm('Install the Organizer service? Requires administrator privileges.')) return;
  const serviceName = document.getElementById('service-name-input').value.trim();
  const scriptsRoot = document.getElementById('scripts-root-input').value.trim();
  const memoryThreshold = parseInt(document.getElementById('memory-threshold-input').value);
  const cpuThreshold = parseInt(document.getElementById('cpu-threshold-input').value);
  showNotification('Installing service... This may take a minute.', 'info');
  
  try {
    const response = await fetch('/api/service/install', {
      method: 'POST', 
      headers: {'Content-Type': 'application/json', ...getAuthHeaders()}, 
      body: JSON.stringify({service_name: serviceName, scripts_root: scriptsRoot, memory_threshold_mb: memoryThreshold, cpu_threshold_percent: cpuThreshold})
    });
    
    const result = await parseResponse(response);
    
    if (result.status === 401 || result.status === 403) {
      showNotification('Authentication required. Please login again.', 'warning');
      return;
    }
    
    if (result.json) {
      if (result.ok && result.json.success) {
        showNotification('Service installed successfully!', 'success');
        if (result.json.output) console.log('Install:', result.json.output);
      } else {
        showNotification(result.json.error || 'Installation failed', 'danger');
        if (result.json.error_output) console.error('Install error:', result.json.error_output);
      }
    } else {
      showNotification(result.text || 'Installation failed', 'danger');
    }
  } catch (err) {
    showNotification('Installation error: ' + err.message, 'danger');
  }
}

async function uninstallService() {
  if (!confirm('Uninstall the Organizer service? This will stop and remove it.')) return;
  const serviceName = document.getElementById('service-name-input').value.trim();
  showNotification('Uninstalling service...', 'info');
  
  try {
    const response = await fetch('/api/service/uninstall', {
      method: 'POST', 
      headers: {'Content-Type': 'application/json', ...getAuthHeaders()}, 
      body: JSON.stringify({service_name: serviceName})
    });
    
    const result = await parseResponse(response);
    
    if (result.status === 401 || result.status === 403) {
      showNotification('Authentication required. Please login again.', 'warning');
      return;
    }
    
    if (result.json) {
      if (result.ok && result.json.success) {
        showNotification('Service uninstalled successfully!', 'success');
      } else {
        showNotification(result.json.error || 'Uninstallation failed', 'danger');
      }
    } else {
      showNotification(result.text || 'Uninstallation failed', 'danger');
    }
  } catch (err) {
    showNotification('Uninstallation error: ' + err.message, 'danger');
  }
}

async function reinstallService() {
  if (!confirm('Reinstall the Organizer service? Will uninstall and reinstall with current settings.')) return;
  const serviceName = document.getElementById('service-name-input').value.trim();
  const scriptsRoot = document.getElementById('scripts-root-input').value.trim();
  const memoryThreshold = parseInt(document.getElementById('memory-threshold-input').value);
  const cpuThreshold = parseInt(document.getElementById('cpu-threshold-input').value);
  showNotification('Reinstalling service... This may take a minute.', 'info');
  
  try {
    const response = await fetch('/api/service/reinstall', {
      method: 'POST', 
      headers: {'Content-Type': 'application/json', ...getAuthHeaders()}, 
      body: JSON.stringify({service_name: serviceName, scripts_root: scriptsRoot, memory_threshold_mb: memoryThreshold, cpu_threshold_percent: cpuThreshold})
    });
    
    const result = await parseResponse(response);
    
    if (result.status === 401 || result.status === 403) {
      showNotification('Authentication required. Please login again.', 'warning');
      return;
    }
    
    if (result.json) {
      if (result.ok && result.json.success) {
        showNotification('Service reinstalled successfully!', 'success');
        if (result.json.output) console.log('Reinstall:', result.json.output);
      } else {
        showNotification(result.json.error || 'Reinstallation failed', 'danger');
        if (result.json.error_output) console.error('Reinstall error:', result.json.error_output);
      }
    } else {
      showNotification(result.text || 'Reinstallation failed', 'danger');
    }
  } catch (err) {
    showNotification('Reinstallation error: ' + err.message, 'danger');
  }
}

function factoryReset() {
  if (!confirm('⚠️ WARNING: Reset ALL configurations to defaults?\\n\\nIncludes:\\n- File organization rules\\n- User accounts (except admin)\\n- Dashboard layout\\n- All settings\\n\\nCannot be undone!')) return;
  if (!confirm('Are you absolutely sure? This will erase all custom configurations!')) return;
  showNotification('Performing factory reset...', 'info');
  fetch('/api/factory-reset', {method: 'POST', headers: {'Content-Type': 'application/json', ...getAuthHeaders()}})
    .then(r => r.json().then(j => ({ok: r.ok, j})))
    .then(({ok, j}) => { if (ok && j.success) { showNotification('Factory reset complete! Redirecting...', 'success'); setTimeout(() => { window.location.href = '/'; }, 2000); } else { showNotification(j.error || 'Factory reset failed', 'danger'); } })
    .catch(err => showNotification('Factory reset error: ' + err.message, 'danger'));
}

async function repairAuth() {
  const username = (document.getElementById('new-username')?.value || '').trim();
  const password = (document.getElementById('new-password')?.value || '').trim();
  const body = { username: username || undefined, password: password || undefined, force_basic: true };
  showNotification('Repairing auth...', 'info');
  try {
    const resp = await fetch('/api/admin/repair_auth', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
      body: JSON.stringify(body)
    });
    const data = await resp.json();
    if (resp.ok && data.success) {
      showNotification('Auth repaired for ' + data.username, 'success');
      fetchConfig();
    } else {
      showNotification(data.error || 'Auth repair failed', 'danger');
    }
  } catch (e) {
    showNotification('Auth repair error: ' + e.message, 'danger');
  }
}

async function viewAuthState() {
  try {
    const resp = await fetch('/api/admin/auth_state', { credentials: 'include', headers: getAuthHeaders() });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.error || 'Failed to fetch auth state');
    const msg = `User: ${data.dashboard_user}\nMethod: ${data.auth_method}\nFallback: ${data.auth_fallback_enabled}\nSetup: ${data.setup_completed}\nUsers: ${data.users.map(u=>u.username+':' + u.role + ' (hash=' + (u.has_hash?'yes':'no') + ')').join(', ')}`;
    showNotification(msg.replaceAll('\n','<br/>'), 'info');
  } catch (e) {
    showNotification('Auth state error: ' + e.message, 'danger');
  }
}

function applyConfigRights() {
  if (!__rights.manage_config) {
    // Disable all user management controls (table buttons, input fields, and save button)
    document.querySelectorAll('#users-table button, #new-username, #new-role, #new-password, button[onclick="saveUser()"]').forEach(el => { 
      if(el) {
        el.disabled = true;
        if (el.tagName === 'BUTTON') {
          el.title = 'Insufficient rights (manage_config)';
        }
      }
    });
  }
  if (!__rights.modify_layout) {
    const saveBtn = document.querySelector('#layout-editor button.btn-success');
    if (saveBtn) { saveBtn.disabled = true; saveBtn.title = 'Insufficient rights (modify_layout)'; }
    // Disable drag by removing draggable attributes
    document.querySelectorAll('#sections-list li').forEach(li => li.removeAttribute('draggable'));
  }
  if (!__rights.manage_service) {
    document.querySelectorAll('#service-name-input, #scripts-root-input, #memory-threshold-input, #cpu-threshold-input').forEach(el => {
      if (el) el.disabled = true;
    });
    document.querySelectorAll('button[onclick^="installService"], button[onclick^="reinstallService"], button[onclick^="uninstallService"]').forEach(el => {
      if (el) { el.disabled = true; el.title = 'Insufficient rights (manage_service)'; }
    });
  }
  if (!__rights.manage_config) {
    const resetBtn = document.querySelector('button[onclick="factoryReset()"]');
    if (resetBtn) resetBtn.style.display = 'none';
  }
}

function renderNetworkTargets(targets){
  const tbody = document.getElementById('network-targets-tbody');
  const rows = Object.entries(targets).map(([name, cfg]) => {
    const path = (cfg && cfg.path) || '';
    const credential_key = (cfg && cfg.credential_key) || '';
    return `<tr>
      <td><small>${name}</small></td>
      <td><small>${path}</small></td>
      <td><small>${credential_key}</small></td>
      <td><button class='btn btn-sm btn-danger' onclick="deleteNetworkTarget('${name}')" title="Delete target">Del</button></td>
    </tr>`;
  }).join('');
  tbody.innerHTML = rows;
}
function addNetworkTarget(){
  const name = document.getElementById('nt-name').value.trim();
  const path = document.getElementById('nt-path').value.trim();
  const credential_key = document.getElementById('nt-cred').value.trim();
  clearInvalid('nt-name'); clearInvalid('nt-path'); clearInvalid('nt-cred');
  if(!name){ return setInvalid('nt-name', 'Name is required.'); }
  if(!isValidUNC(path)){ return setInvalid('nt-path', 'Provide a valid UNC path, e.g., \\server\\share'); }
  if(!credential_key){ return setInvalid('nt-cred', 'Credential key is required.'); }
  dashboardConfig.network_targets = dashboardConfig.network_targets || {};
  dashboardConfig.network_targets[name] = { path, credential_key };
  renderNetworkTargets(dashboardConfig.network_targets);
}
function deleteNetworkTarget(name){
  if(!confirm('Delete network target '+name+'?')) return;
  if(dashboardConfig.network_targets){ delete dashboardConfig.network_targets[name]; }
  renderNetworkTargets(dashboardConfig.network_targets||{});
}
function saveNetworkConfig(){
  // Ensure there is at least one target when saving (optional)
  const payload = { network_targets: dashboardConfig.network_targets || {}, credentials: dashboardConfig.credentials || {} };
  fetch('/api/dashboard/update-config', {method:'POST', headers:{'Content-Type':'application/json', ...getAuthHeaders()}, body: JSON.stringify(payload)})
    .then(r=>r.json().then(j=>({ok:r.ok,j})))
    .then(({ok,j})=>{ if(ok){ showNotification('Network config saved','success'); } else { showNotification(j.error||'Save failed','danger'); } });
}

function renderCredentials(creds){
  const tbody = document.getElementById('credentials-tbody');
  const rows = Object.entries(creds).map(([key, c]) => {
    return `<tr>
      <td><small>${key}</small></td>
      <td><small>${c.username||''}</small></td>
      <td><small>${c.password_b64||''}</small></td>
      <td><button class='btn btn-sm btn-danger' onclick="deleteCredential('${key}')" title="Delete credential">Del</button></td>
    </tr>`;
  }).join('');
  tbody.innerHTML = rows;
}
function addCredential(){
  const key = document.getElementById('cred-key').value.trim();
  const username = document.getElementById('cred-user').value.trim();
  const password_b64 = document.getElementById('cred-pass-b64').value.trim();
  clearInvalid('cred-key'); clearInvalid('cred-pass-b64');
  if(!key){ return setInvalid('cred-key', 'Credential key is required.'); }
  if(password_b64 && !isValidBase64(password_b64)){ return setInvalid('cred-pass-b64', 'Password must be base64-encoded.'); }
  dashboardConfig.credentials = dashboardConfig.credentials || {};
  dashboardConfig.credentials[key] = { username, password_b64 };
  renderCredentials(dashboardConfig.credentials);
}
function deleteCredential(key){
  if(!confirm('Delete credential '+key+'?')) return;
  if(dashboardConfig.credentials){ delete dashboardConfig.credentials[key]; }
  renderCredentials(dashboardConfig.credentials||{});
}
function renderSmtp(smtp){
  document.getElementById('smtp-host').value = smtp.host || '';
  document.getElementById('smtp-port').value = smtp.port || 587;
  document.getElementById('smtp-from').value = smtp.from || '';
  document.getElementById('smtp-to').value = smtp.to || '';
  document.getElementById('smtp-user').value = smtp.username || '';
  document.getElementById('smtp-pass').value = smtp.password || '';
  document.getElementById('smtp-tls').checked = (smtp.tls !== false);
}
function saveSmtpAndCredentials(){
  const smtp = {
    host: document.getElementById('smtp-host').value.trim(),
    port: parseInt(document.getElementById('smtp-port').value) || 587,
    from: document.getElementById('smtp-from').value.trim(),
    to: document.getElementById('smtp-to').value.trim(),
    username: document.getElementById('smtp-user').value.trim(),
    password: document.getElementById('smtp-pass').value,
    tls: document.getElementById('smtp-tls').checked
  };
  // Validate SMTP fields
  clearInvalid('smtp-host'); clearInvalid('smtp-port'); clearInvalid('smtp-from'); clearInvalid('smtp-to');
  if(!smtp.host){ return setInvalid('smtp-host', 'SMTP host is required.'); }
  if(!(smtp.port>=1 && smtp.port<=65535)){ return setInvalid('smtp-port', 'Port must be between 1 and 65535.'); }
  if(!isValidEmail(smtp.from)){ return setInvalid('smtp-from', 'Enter a valid email address.'); }
  if(!validateEmails(smtp.to)){ return setInvalid('smtp-to', 'Enter one or more valid email addresses.'); }
  const payload = { smtp, credentials: dashboardConfig.credentials || {} };
  fetch('/api/dashboard/update-config', {method:'POST', headers:{'Content-Type':'application/json', ...getAuthHeaders()}, body: JSON.stringify(payload)})
    .then(r=>r.json().then(j=>({ok:r.ok,j})))
    .then(({ok,j})=>{ if(ok){ showNotification('SMTP & credentials saved','success'); } else { showNotification(j.error||'Save failed','danger'); } });
}
function testSMTP(){
  const smtp = {
    host: document.getElementById('smtp-host').value.trim(),
    port: parseInt(document.getElementById('smtp-port').value) || 587,
    from: document.getElementById('smtp-from').value.trim(),
    to: document.getElementById('smtp-to').value.trim(),
    username: document.getElementById('smtp-user').value.trim(),
    password: document.getElementById('smtp-pass').value,
    tls: document.getElementById('smtp-tls').checked
  };
  clearInvalid('smtp-host'); clearInvalid('smtp-port'); clearInvalid('smtp-from'); clearInvalid('smtp-to');
  if(!smtp.host){ return setInvalid('smtp-host', 'SMTP host is required.'); }
  if(!(smtp.port>=1 && smtp.port<=65535)){ return setInvalid('smtp-port', 'Port must be between 1 and 65535.'); }
  if(!isValidEmail(smtp.from)){ return setInvalid('smtp-from', 'Enter a valid email address.'); }
  if(!validateEmails(smtp.to)){ return setInvalid('smtp-to', 'Enter one or more valid email addresses.'); }
  showNotification('Sending test email...', 'info');
  fetch('/api/test/smtp', {method:'POST', headers:{'Content-Type':'application/json', ...getAuthHeaders()}, body: JSON.stringify(smtp)})
    .then(r=>r.json().then(j=>({ok:r.ok,j})))
    .then(({ok,j})=>{ if(ok){ showNotification(j.message||'SMTP test succeeded','success'); } else { showNotification(j.error||'SMTP test failed','danger'); } })
    .catch(e=>showNotification('SMTP test error: '+e.message,'danger'));
}
function testNAS(){
  const path = document.getElementById('nt-path').value.trim();
  const credential_key = document.getElementById('nt-cred').value.trim();
  clearInvalid('nt-path');
  if(!isValidUNC(path)){ return setInvalid('nt-path', 'Provide a valid UNC path.'); }
  showNotification('Testing NAS path...', 'info');
  fetch('/api/test/nas', {method:'POST', headers:{'Content-Type':'application/json', ...getAuthHeaders()}, body: JSON.stringify({path, credential_key})})
    .then(r=>r.json().then(j=>({ok:r.ok,j})))
    .then(({ok,j})=>{ if(ok){ showNotification(j.message||'NAS test succeeded','success'); } else { showNotification(j.error||'NAS test failed','danger'); } })
    .catch(e=>showNotification('NAS test error: '+e.message,'danger'));
}

function applyNASTemplate(){
  const template = document.getElementById('nas-template').value;
  if(!template) return;
  const templates = {
    synology: {
      name: 'synology_nas',
      path: '\\\\synology.local\\downloads',
      credential_key: 'synology_admin',
      hint: 'Replace synology.local with your NAS hostname/IP'
    },
    qnap: {
      name: 'qnap_nas',
      path: '\\\\qnap.local\\Public\\Downloads',
      credential_key: 'qnap_admin',
      hint: 'Replace qnap.local with your NAS hostname/IP'
    },
    windows: {
      name: 'windows_share',
      path: '\\\\SERVER\\SharedFolder',
      credential_key: 'domain_user',
      hint: 'Replace SERVER and SharedFolder with your share details'
    },
    generic: {
      name: 'nas_target',
      path: '\\\\192.168.1.100\\share',
      credential_key: 'nas_default',
      hint: 'Generic SMB/CIFS share template'
    }
  };
  const t = templates[template];
  if(t){
    document.getElementById('nt-name').value = t.name;
    document.getElementById('nt-path').value = t.path;
    document.getElementById('nt-cred').value = t.credential_key;
    showNotification(t.hint, 'info');
  }
}

function applySMTPTemplate(){
  const template = document.getElementById('smtp-template').value;
  if(!template) return;
  const templates = {
    gmail: {
      host: 'smtp.gmail.com',
      port: 587,
      tls: true,
      hint: 'Gmail requires an App Password (not your account password). Enable 2FA and generate one at myaccount.google.com/apppasswords'
    },
    outlook: {
      host: 'smtp-mail.outlook.com',
      port: 587,
      tls: true,
      hint: 'Outlook.com SMTP settings. Use your full email and password.'
    },
    office365: {
      host: 'smtp.office365.com',
      port: 587,
      tls: true,
      hint: 'Office 365 SMTP. Use your organizational email and password.'
    },
    yahoo: {
      host: 'smtp.mail.yahoo.com',
      port: 587,
      tls: true,
      hint: 'Yahoo Mail requires an App Password. Generate one in Account Security settings.'
    },
    generic: {
      host: 'smtp.example.com',
      port: 587,
      tls: true,
      hint: 'Generic SMTP template. Update host and credentials.'
    }
  };
  const t = templates[template];
  if(t){
    document.getElementById('smtp-host').value = t.host;
    document.getElementById('smtp-port').value = t.port;
    document.getElementById('smtp-tls').checked = t.tls;
    showNotification(t.hint, 'info');
  }
}
</script>
{% endblock %}