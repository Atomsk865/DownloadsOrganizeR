{% extends "dashboard_base.html" %}
{% block dashboard_content %}
<div class="mb-3 d-flex justify-content-between align-items-center">
  <h5 class="mb-0">Dashboard Configuration</h5>
  <div>
    <button class="btn btn-sm btn-danger me-2" onclick="factoryReset()" data-right="manage_config" title="Reset all settings to defaults">
      <i class="bi bi-exclamation-triangle"></i> Factory Reset
    </button>
      <button class="btn btn-sm btn-outline-primary me-2" onclick="resetSetup()" data-right="manage_config" title="Re-run initial setup wizard">
        <i class="bi bi-arrow-counterclockwise"></i> Re-run Setup
      </button>
      <button class="btn btn-sm btn-success me-2" onclick="repairAuth()" data-right="manage_config" title="Align admin credentials across configs">
        <i class="bi bi-shield-lock"></i> Repair Auth
      </button>
      <button class="btn btn-sm btn-outline-info me-2" onclick="viewAuthState()" data-right="manage_config" title="View current auth state">
        <i class="bi bi-info-circle"></i> Auth State
      </button>
    <a href="/" class="btn btn-sm btn-outline-secondary">Back to Dashboard</a>
  </div>
</div>
<div class="row g-3" id="config-root" data-right="manage_config">
  <div class="col-md-5">
    <div class="card">
      <div class="card-header"><b>Users & Roles</b></div>
      <div class="card-body p-2">
        <table class="table table-sm" id="users-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Role</th>
              <th style="width:80px">Actions</th>
            </tr>
          </thead>
          <tbody id="users-tbody"></tbody>
        </table>
        <hr class="mt-2 mb-2"/>
        <div class="mb-2"><b>Add / Update User</b></div>
        <div class="mb-2">
          <input id="new-username" class="form-control form-control-sm" placeholder="Username">
        </div>
        <div class="mb-2">
          <select id="new-role" class="form-select form-select-sm"></select>
        </div>
        <div class="mb-2">
          <input id="new-password" class="form-control form-control-sm" type="password" placeholder="Password (leave blank to keep)">
        </div>
        <button class="btn btn-primary btn-sm" onclick="saveUser()">Save User</button>
      </div>
    </div>
    <div class="card mt-3">
      <div class="card-header"><b>Role Rights</b></div>
      <div class="card-body p-2">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th>Role</th>
              <th>Rights</th>
            </tr>
          </thead>
          <tbody>
            {% for role, rights in roles.items() %}
            <tr>
              <td><small>{{ role }}</small></td>
              <td>
                {% for r, allowed in rights.items() %}
                  <span class="badge bg-{{ 'success' if allowed else 'secondary' }} mb-1">{{ r }}</span>
                {% endfor %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="col-md-7" id="layout-editor" data-right="modify_layout">
      <div class="col-md-7">
        <div class="card mb-3" data-right="manage_service">
          <div class="card-header"><b>Service Installation</b></div>
          <div class="card-body p-2">
            <div class="mb-2">
              <label class="form-label mb-1"><small><b>Service Name</b></small></label>
              <input id="service-name-input" class="form-control form-control-sm" value="DownloadsOrganizer">
            </div>
            <div class="mb-2">
              <label class="form-label mb-1"><small><b>Scripts Root Directory</b></small></label>
              <input id="scripts-root-input" class="form-control form-control-sm" value="C:\Scripts">
            </div>
            <div class="row">
              <div class="col-md-6 mb-2">
                <label class="form-label mb-1"><small><b>Memory Threshold (MB)</b></small></label>
                <input id="memory-threshold-input" type="number" class="form-control form-control-sm" value="200">
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label mb-1"><small><b>CPU Threshold (%)</b></small></label>
                <input id="cpu-threshold-input" type="number" class="form-control form-control-sm" value="60">
              </div>
            </div>
            <div class="d-flex gap-2 mt-2">
              <button class="btn btn-primary btn-sm" onclick="installService()">
                <i class="bi bi-download"></i> Install Service
              </button>
              <button class="btn btn-warning btn-sm" onclick="reinstallService()">
                <i class="bi bi-arrow-repeat"></i> Reinstall
              </button>
              <button class="btn btn-danger btn-sm" onclick="uninstallService()">
                <i class="bi bi-trash"></i> Uninstall Service
              </button>
            </div>
            <div class="mt-2">
              <small class="text-muted">
                <i class="bi bi-info-circle"></i> Service installation requires Windows and administrator privileges.
              </small>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-7" id="layout-editor" data-right="modify_layout">
    <div class="card">
      <div class="card-header"><b>Layout (Drag to Reorder)</b></div>
      <div class="card-body p-2">
        <ul id="sections-list" class="list-group mb-2"></ul>
        <div class="mb-2">
          <small class="text-muted">Check to hide a section. Drag handles on left to reorder.</small>
        </div>
        <button class="btn btn-success btn-sm" onclick="saveLayout()">Save Layout</button>
      </div>
    </div>
  </div>
</div>
{% include "dashboard_scripts.html" %}
<script>
let dashboardConfig = null;
function fetchConfig() {
  fetch('/api/dashboard/config', {headers: getAuthHeaders()})
    .then(r => { if(!r.ok) throw new Error('Failed'); return r.json(); })
    .then(data => {
      dashboardConfig = data;
      renderUsers(data.users);
      renderRoles(Object.keys(data.roles));
      renderLayout(data.layout);
    })
    .catch(err => showNotification('Load failed: ' + err.message, 'danger'));
}
function renderUsers(users){
  const tbody = document.getElementById('users-tbody');
  tbody.innerHTML = users.map(u => {
    return `<tr><td><small>${u.username}</small></td><td><small>${u.role}</small></td><td><button class='btn btn-sm btn-danger' onclick="deleteUser('${u.username}')">Del</button></td></tr>`;
  }).join('');
  // Reapply rights after rendering dynamic content
  if (typeof applyConfigRights === 'function') {
    applyConfigRights();
  }
}
function renderRoles(roleNames){
  const sel = document.getElementById('new-role');
  sel.innerHTML = roleNames.map(r => `<option value='${r}'>${r}</option>`).join('');
}
function saveUser(){
  const username = document.getElementById('new-username').value.trim();
  const role = document.getElementById('new-role').value.trim();
  const password = document.getElementById('new-password').value;
  if(!username || !role){ showNotification('Username and role required', 'warning'); return; }
  fetch('/api/dashboard/users', {method:'POST', headers: {'Content-Type':'application/json', ...getAuthHeaders()}, body: JSON.stringify({username, role, password: password || undefined})})
    .then(r=>r.json().then(j=>({ok:r.ok, j})))
    .then(({ok,j})=>{ if(ok){ showNotification('User saved', 'success'); document.getElementById('new-password').value=''; fetchConfig(); } else { showNotification(j.error||'Save failed','danger'); } });
}
function deleteUser(username){
  if(!confirm('Delete user ' + username + '?')) return;
  fetch('/api/dashboard/users/' + encodeURIComponent(username), {method:'DELETE', headers: getAuthHeaders()})
    .then(r=>r.json().then(j=>({ok:r.ok,j})))
    .then(({ok,j})=>{ if(ok){ showNotification('User deleted', 'success'); fetchConfig(); } else { showNotification(j.error||'Delete failed','danger'); } });
}
function renderLayout(layout){
  const list = document.getElementById('sections-list');
  const order = layout.sections_order || [];
  const hidden = new Set(layout.hidden_sections || []);
  list.innerHTML = order.map(sec => {
    const checked = hidden.has(sec) ? 'checked' : '';
    return `<li class='list-group-item d-flex align-items-center' draggable='true' ondragstart='dragStart(event)' ondragover='dragOver(event)' ondrop='dropItem(event)'>
      <span class='me-2 text-muted' style='cursor:grab'>&#9776;</span>
      <input type='checkbox' class='form-check-input me-2' data-section='${sec}' ${checked} />
      <span>${sec}</span>
    </li>`;
  }).join('');
  // Reapply rights after rendering dynamic content
  if (typeof applyConfigRights === 'function') {
    applyConfigRights();
  }
}
let dragSrcEl = null;
function dragStart(e){ dragSrcEl = e.currentTarget; e.dataTransfer.effectAllowed='move'; }
function dragOver(e){ e.preventDefault(); e.dataTransfer.dropEffect='move'; }
function dropItem(e){ e.preventDefault(); const target = e.currentTarget; if(dragSrcEl && dragSrcEl!==target){ const list = target.parentNode; const items=[...list.children]; const srcIndex=items.indexOf(dragSrcEl); const tgtIndex=items.indexOf(target); if(srcIndex < tgtIndex){ list.insertBefore(dragSrcEl, target.nextSibling); } else { list.insertBefore(dragSrcEl, target); } } }
function saveLayout(){
  const items = [...document.querySelectorAll('#sections-list li')];
  const sections_order = items.map(li => li.querySelector('span:last-of-type').textContent.trim());
  const hidden_sections = items.filter(li => li.querySelector('input').checked).map(li => li.querySelector('span:last-of-type').textContent.trim());
  fetch('/api/dashboard/layout', {method:'POST', headers:{'Content-Type':'application/json', ...getAuthHeaders()}, body: JSON.stringify({sections_order, hidden_sections})})
    .then(r=>r.json().then(j=>({ok:r.ok,j})))
    .then(({ok,j})=>{ if(ok){ showNotification('Layout saved','success'); } else { showNotification(j.error||'Layout save failed','danger'); } });
}
// Initialize
document.addEventListener('DOMContentLoaded', () => {
  // Restore auth from sessionStorage if not already set
  if (typeof __authHeader === 'undefined' || !__authHeader) {
    try {
      const storedAuth = sessionStorage.getItem('authHeader');
      if (storedAuth) {
        __authHeader = storedAuth;
      }
    } catch (e) {
      console.warn('sessionStorage not available:', e);
    }
  }
  
  // Verify auth and load rights if we have credentials
  if (__authHeader) {
    fetch('/auth_check', {
      credentials: 'include',
      headers: { 'Authorization': __authHeader }
    }).then(response => {
      if (response.ok) {
        return response.json();
      } else {
        throw new Error('Auth check failed');
      }
    }).then(data => {
      __rights = data.rights || {};
      __configVersion = data.config_version || 0;
      applyConfigRights();
      // Fetch config AFTER rights are loaded to avoid race condition
      fetchConfig();
    }).catch(err => {
      console.error('Auth check failed:', err);
      showNotification('Authentication failed. Please login again.', 'danger');
      setTimeout(() => { window.location.href = '/'; }, 2000);
    });
  } else {
    showNotification('Not logged in. Redirecting...', 'warning');
    setTimeout(() => { window.location.href = '/'; }, 2000);
  }
});

function applyConfigRights() {
  if (!__rights.manage_config) {
    // Disable all user management controls (table buttons, input fields, and save button)
    document.querySelectorAll('#users-table button, #new-username, #new-role, #new-password, button[onclick="saveUser()"]').forEach(el => { 
      if(el) {
        el.disabled = true;
        if (el.tagName === 'BUTTON') {
          el.title = 'Insufficient rights (manage_config)';
        }
      }
    });
  }
  // Add reset setup function in scope
  function resetSetup(){
    if(!confirm('Re-run setup wizard? Users will be redirected to setup page and must complete it again to access dashboard.')) return;
    fetch('/api/setup/reset', {method:'POST', headers: getAuthHeaders()})
      .then(r=>r.json().then(j=>({ok:r.ok,j})))
      .then(({ok,j})=>{ if(ok && j.success){ showNotification('Setup reset. Redirecting to wizard...', 'success'); setTimeout(()=>{ window.location.href='/setup'; },1500); } else { showNotification(j.error||'Reset failed','danger'); } });
  }
  if (!__rights.modify_layout) {
    const saveBtn = document.querySelector('#layout-editor button.btn-success');
    if (saveBtn) { saveBtn.disabled = true; saveBtn.title = 'Insufficient rights (modify_layout)'; }
    // Disable drag by removing draggable attributes
    document.querySelectorAll('#sections-list li').forEach(li => li.removeAttribute('draggable'));
    if (!__rights.manage_service) {
      document.querySelectorAll('#service-name-input, #scripts-root-input, #memory-threshold-input, #cpu-threshold-input').forEach(el => {
        if (el) el.disabled = true;
      });
      document.querySelectorAll('button[onclick^="installService"], button[onclick^="reinstallService"], button[onclick^="uninstallService"]').forEach(el => {
        if (el) { el.disabled = true; el.title = 'Insufficient rights (manage_service)'; }
      });
    }
    if (!__rights.manage_config) {
      const resetBtn = document.querySelector('button[onclick="factoryReset()"]');
      if (resetBtn) resetBtn.style.display = 'none';
    }
  }
  function installService() {
    if (!confirm('Install the Organizer service? Requires administrator privileges.')) return;
    const serviceName = document.getElementById('service-name-input').value.trim();
    const scriptsRoot = document.getElementById('scripts-root-input').value.trim();
    const memoryThreshold = parseInt(document.getElementById('memory-threshold-input').value);
    const cpuThreshold = parseInt(document.getElementById('cpu-threshold-input').value);
    showNotification('Installing service... This may take a minute.', 'info');
    fetch('/api/service/install', {method: 'POST', headers: {'Content-Type': 'application/json', ...getAuthHeaders()}, body: JSON.stringify({service_name: serviceName, scripts_root: scriptsRoot, memory_threshold_mb: memoryThreshold, cpu_threshold_percent: cpuThreshold})})
      .then(r => r.json().then(j => ({ok: r.ok, j})))
      .then(({ok, j}) => { if (ok && j.success) { showNotification('Service installed successfully!', 'success'); if (j.output) console.log('Install:', j.output); } else { showNotification(j.error || 'Installation failed', 'danger'); if (j.error_output) console.error('Install error:', j.error_output); } })
      .catch(err => showNotification('Installation error: ' + err.message, 'danger'));
  }
  function uninstallService() {
    if (!confirm('Uninstall the Organizer service? This will stop and remove it.')) return;
    const serviceName = document.getElementById('service-name-input').value.trim();
    showNotification('Uninstalling service...', 'info');
    fetch('/api/service/uninstall', {method: 'POST', headers: {'Content-Type': 'application/json', ...getAuthHeaders()}, body: JSON.stringify({service_name: serviceName})})
      .then(r => r.json().then(j => ({ok: r.ok, j})))
      .then(({ok, j}) => { if (ok && j.success) { showNotification('Service uninstalled successfully!', 'success'); } else { showNotification(j.error || 'Uninstallation failed', 'danger'); } })
      .catch(err => showNotification('Uninstallation error: ' + err.message, 'danger'));
  }
  function reinstallService() {
    if (!confirm('Reinstall the Organizer service? Will uninstall and reinstall with current settings.')) return;
    const serviceName = document.getElementById('service-name-input').value.trim();
    const scriptsRoot = document.getElementById('scripts-root-input').value.trim();
    const memoryThreshold = parseInt(document.getElementById('memory-threshold-input').value);
    const cpuThreshold = parseInt(document.getElementById('cpu-threshold-input').value);
    showNotification('Reinstalling service... This may take a minute.', 'info');
    fetch('/api/service/reinstall', {method: 'POST', headers: {'Content-Type': 'application/json', ...getAuthHeaders()}, body: JSON.stringify({service_name: serviceName, scripts_root: scriptsRoot, memory_threshold_mb: memoryThreshold, cpu_threshold_percent: cpuThreshold})})
      .then(r => r.json().then(j => ({ok: r.ok, j})))
      .then(({ok, j}) => { if (ok && j.success) { showNotification('Service reinstalled successfully!', 'success'); if (j.output) console.log('Reinstall:', j.output); } else { showNotification(j.error || 'Reinstallation failed', 'danger'); if (j.error_output) console.error('Reinstall error:', j.error_output); } })
      .catch(err => showNotification('Reinstallation error: ' + err.message, 'danger'));
  }
  function factoryReset() {
    if (!confirm('⚠️ WARNING: Reset ALL configurations to defaults?\\n\\nIncludes:\\n- File organization rules\\n- User accounts (except admin)\\n- Dashboard layout\\n- All settings\\n\\nCannot be undone!')) return;
    if (!confirm('Are you absolutely sure? This will erase all custom configurations!')) return;
    showNotification('Performing factory reset...', 'info');
    fetch('/api/factory-reset', {method: 'POST', headers: {'Content-Type': 'application/json', ...getAuthHeaders()}})
      .then(r => r.json().then(j => ({ok: r.ok, j})))
      .then(({ok, j}) => { if (ok && j.success) { showNotification('Factory reset complete! Redirecting...', 'success'); setTimeout(() => { window.location.href = '/'; }, 2000); } else { showNotification(j.error || 'Factory reset failed', 'danger'); } })
      .catch(err => showNotification('Factory reset error: ' + err.message, 'danger'));
  }

  async function repairAuth() {
    const username = (document.getElementById('new-username')?.value || '').trim();
    const password = (document.getElementById('new-password')?.value || '').trim();
    const body = { username: username || undefined, password: password || undefined, force_basic: true };
    showNotification('Repairing auth...', 'info');
    try {
      const resp = await fetch('/api/admin/repair_auth', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
        body: JSON.stringify(body)
      });
      const data = await resp.json();
      if (resp.ok && data.success) {
        showNotification('Auth repaired for ' + data.username, 'success');
        fetchConfig();
      } else {
        showNotification(data.error || 'Auth repair failed', 'danger');
      }
    } catch (e) {
      showNotification('Auth repair error: ' + e.message, 'danger');
    }
  }

  async function viewAuthState() {
    try {
      const resp = await fetch('/api/admin/auth_state', { credentials: 'include', headers: getAuthHeaders() });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.error || 'Failed to fetch auth state');
      const msg = `User: ${data.dashboard_user}\nMethod: ${data.auth_method}\nFallback: ${data.auth_fallback_enabled}\nSetup: ${data.setup_completed}\nUsers: ${data.users.map(u=>u.username+':' + u.role + ' (hash=' + (u.has_hash?'yes':'no') + ')').join(', ')}`;
      showNotification(msg.replaceAll('\n','<br/>'), 'info');
    } catch (e) {
      showNotification('Auth state error: ' + e.message, 'danger');
    }
  }
}
</script>
{% endblock %}