{% extends "dashboard_base.html" %}
{% block dashboard_content %}
<style>
    #config-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        width: 95%;
        max-width: 1600px;
        margin: 0 auto;
        padding: 1rem;
    }
    .config-module {
        flex: 1 1 calc(50% - 0.5rem);
        min-width: 400px;
        transition: all 0.3s ease;
        position: relative;
        background: var(--bg-secondary);
        border-radius: 0.375rem;
    }
    .config-module.dragging {
        opacity: 0.6;
        transform: scale(0.98);
        z-index: 1000;
        box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    }
    .config-module.drag-over {
        border: 3px solid #0d6efd;
        background-color: rgba(13, 110, 253, 0.05);
    }
    .config-module.full-width {
        flex: 1 1 100%;
        min-width: 100%;
    }
    .drag-handle {
        cursor: move;
        padding: 4px 10px;
        font-size: 1.1rem;
        color: var(--text-secondary) !important;
        transition: color 0.2s;
    }
    .drag-handle:hover {
        color: #0d6efd !important;
    }
    @media (max-width: 1024px) {
        .config-module {
            flex: 1 1 100%;
            min-width: 100%;
        }
    }
    @media (max-width: 768px) {
        #config-grid {
            width: 100%;
            padding: 0.5rem;
            gap: 0.75rem;
        }
        .config-module {
            min-width: 0;
        }
        .config-module .card-header {
            padding: 0.85rem 1rem;
            font-size: 1rem;
            cursor: pointer;
            user-select: none;
        }
        .config-module .card-header::after {
            content: '\f282';
            font-family: 'bootstrap-icons';
            float: right;
            margin-left: 10px;
            transition: transform 0.3s;
        }
        .config-module.collapsed .card-header::after {
            transform: rotate(-90deg);
        }
        .config-module.collapsed .card-body {
            display: none;
        }
        .config-module .card-body {
            padding: 0.75rem;
        }
        .config-module table {
            font-size: 0.85rem;
        }
        .config-module td,
        .config-module th {
            padding: 0.5rem 0.4rem;
        }
        /* Stack config header buttons */
        .mb-3.d-flex {
            flex-direction: column;
            align-items: stretch !important;
            gap: 0.5rem;
        }
        .mb-3.d-flex > div {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .mb-3.d-flex .btn,
        .mb-3.d-flex a {
            width: 100%;
            text-align: center;
        }
        /* Horizontal scroll for tables */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    }
    @media (max-width: 480px) {
        .config-module .card-header {
            font-size: 0.95rem;
        }
        .config-module table {
            font-size: 0.8rem;
        }
    }
</style>
<div class="mb-3 d-flex justify-content-between align-items-center" style="max-width: 1600px; margin: 0 auto; width: 95%;">
  <h5 class="mb-0">Dashboard Configuration</h5>
  <div>
    <button class="btn btn-sm btn-primary me-2" onclick="exportConfig()" data-right="manage_config" title="Download complete configuration backup">
      <i class="bi bi-download"></i> Export Config
    </button>
    <button class="btn btn-sm btn-warning me-2" onclick="document.getElementById('import-file-input').click()" data-right="manage_config" title="Import configuration from backup file">
      <i class="bi bi-upload"></i> Import Config
    </button>
    <input type="file" id="import-file-input" accept=".json" style="display: none;" onchange="handleImportFile(event)">
    <button class="btn btn-sm btn-danger me-2" onclick="factoryReset()" data-right="manage_config" title="Reset all settings to defaults">
      <i class="bi bi-exclamation-triangle"></i> Factory Reset
    </button>
      <button class="btn btn-sm btn-outline-primary me-2" onclick="resetSetup()" data-right="manage_config" title="Re-run initial setup wizard">
        <i class="bi bi-arrow-counterclockwise"></i> Re-run Setup
      </button>
      <button class="btn btn-sm btn-success me-2" onclick="repairAuth()" data-right="manage_config" title="Align admin credentials across configs">
        <i class="bi bi-shield-lock"></i> Repair Auth
      </button>
      <button class="btn btn-sm btn-outline-info me-2" onclick="viewAuthState()" data-right="manage_config" title="View current auth state">
        <i class="bi bi-info-circle"></i> Auth State
      </button>
      <div class="btn-group me-2">
        <button type="button" class="btn btn-sm btn-outline-dark dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" title="Open documentation in new tab">
          <i class="bi bi-book"></i> Docs
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="/docs/readme" target="_blank">Project README</a></li>
          <li><a class="dropdown-item" href="/docs/configuration" target="_blank">Configuration Guide</a></li>
          <li><a class="dropdown-item" href="/docs/authentication" target="_blank">Authentication Guide</a></li>
          <li><a class="dropdown-item" href="/docs/recent-files" target="_blank">Recent Files</a></li>
          <li><a class="dropdown-item" href="/docs/duplicate-detection" target="_blank">Duplicate Detection</a></li>
        </ul>
      </div>
    <a href="/" class="btn btn-sm btn-outline-secondary">Back to Dashboard</a>
  </div>
</div>
<div id="config-grid">
  <!-- Features & Integrations -->
  <div class="config-module" data-module="features-integrations" draggable="true">
    <div class="card">
      <div class="card-header d-flex align-items-center">
        <b>Features & Integrations</b>
        <span class="drag-handle ms-auto" style="cursor: move; padding: 4px 10px; font-size: 1.1rem; color: #6c757d;"><i class="bi bi-grip-vertical"></i></span>
      </div>
      <div class="card-body p-2">
        <div class="row g-2">
          <div class="col-md-8">
            <label class="form-label mb-1"><small><b>VirusTotal API Key</b> (optional)</small></label>
            <input class="form-control form-control-sm" id="cfg-vt-api-key" placeholder="Paste your VirusTotal API key">
            <small class="text-muted">Used for hash lookups in Recent Files. Leave blank to disable.</small>
          </div>
          <div class="col-md-4">
            <label class="form-label mb-1"><small><b>Feature Toggles</b></small></label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="cfg-feat-virustotal" checked>
              <label class="form-check-label"><small>VirusTotal integration</small></label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="cfg-feat-duplicates" checked>
              <label class="form-check-label"><small>Duplicate Detection</small></label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="cfg-feat-reports" checked>
              <label class="form-check-label"><small>Reports & Analytics</small></label>
            </div>
          </div>
        </div>
        <div class="mt-2 d-flex justify-content-end">
          <button class="btn btn-sm btn-primary" onclick="saveFeaturesConfig()" data-right="manage_config"><i class="bi bi-save"></i> Save Features</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Users & Roles -->
  <div class="config-module" data-module="users-roles" draggable="true">
    <div class="card">
      <div class="card-header d-flex align-items-center">
        <b>Users & Roles</b>
        <span class="drag-handle ms-auto" style="cursor: move; padding: 4px 10px; font-size: 1.1rem; color: #6c757d;"><i class="bi bi-grip-vertical"></i></span>
      </div>
      <div class="card-body p-2">
        <div class="mb-2">
          <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="search-users" placeholder="Search users..." oninput="filterUsers()">
            <button class="btn btn-outline-secondary" onclick="clearUserSearch()" title="Clear search">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>
        <table class="table table-sm" id="users-table">
          <thead>
            <tr>
              <th>Username</th>
              <th>Role</th>
              <th style="width:80px">Actions</th>
            </tr>
          </thead>
          <tbody id="users-tbody"></tbody>
        </table>
        <hr class="mt-2 mb-2"/>
        <div class="mb-2"><b>Add / Update User</b></div>
        <div class="mb-2">
          <input id="new-username" class="form-control form-control-sm" placeholder="Username">
        </div>
        <div class="mb-2">
          <select id="new-role" class="form-select form-select-sm"></select>
        </div>
        <div class="mb-2">
          <input id="new-password" class="form-control form-control-sm" type="password" placeholder="Password (leave blank to keep)">
        </div>
        <button class="btn btn-primary btn-sm" onclick="saveUser()">Save User</button>
      </div>
    </div>
  </div>
  
  <!-- Role Rights -->
  <div class="config-module" data-module="role-rights" draggable="true">
    <div class="card">
      <div class="card-header d-flex align-items-center">
        <b>Role Rights</b>
        <span class="drag-handle ms-auto" style="cursor: move; padding: 4px 10px; font-size: 1.1rem; color: #6c757d;"><i class="bi bi-grip-vertical"></i></span>
      </div>
      <div class="card-body p-2">
        <div class="mb-2">
          <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="search-roles" placeholder="Search roles..." oninput="filterRoles()">
            <button class="btn btn-outline-secondary" onclick="clearRoleSearch()" title="Clear search">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th>Role</th>
              <th>Rights</th>
            </tr>
          </thead>
          <tbody>
            {% for role, rights in roles.items() %}
            <tr>
              <td><small>{{ role }}</small></td>
              <td>
                {% for r, allowed in rights.items() %}
                  <span class="badge bg-{{ 'success' if allowed else 'secondary' }} mb-1">{{ r }}</span>
                {% endfor %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Service Installation -->
  <div class="config-module" data-module="service-install" draggable="true">
        <div class="card" data-right="manage_service">
          <div class="card-header d-flex align-items-center">
            <b>Service Installation</b>
            <span class="drag-handle ms-auto" style="cursor: move; padding: 4px 10px; font-size: 1.1rem; color: #6c757d;"><i class="bi bi-grip-vertical"></i></span>
          </div>
          <div class="card-body p-2">
            <div class="mb-2">
              <label class="form-label mb-1"><small><b>Service Name</b></small></label>
              <input id="service-name-input" class="form-control form-control-sm" value="DownloadsOrganizer">
            </div>
            <div class="mb-2">
              <label class="form-label mb-1"><small><b>Scripts Root Directory</b></small></label>
              <input id="scripts-root-input" class="form-control form-control-sm" value="C:\Scripts">
            </div>
            <div class="row">
              <div class="col-md-6 mb-2">
                <label class="form-label mb-1"><small><b>Memory Threshold (MB)</b></small></label>
                <input id="memory-threshold-input" type="number" class="form-control form-control-sm" value="200">
              </div>
              <div class="col-md-6 mb-2">
                <label class="form-label mb-1"><small><b>CPU Threshold (%)</b></small></label>
                <input id="cpu-threshold-input" type="number" class="form-control form-control-sm" value="60">
              </div>
            </div>
            <div class="d-flex gap-2 mt-2">
              <button class="btn btn-primary btn-sm" onclick="installService()">
                <i class="bi bi-download"></i> Install Service
              </button>
              <button class="btn btn-warning btn-sm" onclick="reinstallService()">
                <i class="bi bi-arrow-repeat"></i> Reinstall
              </button>
              <button class="btn btn-danger btn-sm" onclick="uninstallService()">
                <i class="bi bi-trash"></i> Uninstall Service
              </button>
            </div>
            <div class="mt-2">
              <small class="text-muted">
                <i class="bi bi-info-circle"></i> Service installation requires Windows and administrator privileges.
              </small>
            </div>
          </div>
        </div>
  </div>
  
  <!-- Network Targets -->
  <div class="config-module" data-module="network-targets" draggable="true">
    <div class="card" data-right="manage_config">
      <div class="card-header d-flex align-items-center">
        <b>Network Targets (NAS/SMB)</b>
        <span class="drag-handle ms-auto" style="cursor: move; padding: 4px 10px; font-size: 1.1rem; color: #6c757d;"><i class="bi bi-grip-vertical"></i></span>
      </div>
      <div class="card-body p-2">
        <div class="mb-2">
          <div class="input-group input-group-sm mb-2">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="search-network-targets" placeholder="Search network targets..." oninput="filterNetworkTargets()">
            <button class="btn btn-outline-secondary" onclick="clearNetworkTargetSearch()" title="Clear search">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
          <label class="form-label mb-1"><small><b>Template</b></small></label>
          <select class="form-select form-select-sm" id="nas-template" onchange="applyNASTemplate()" title="Quick setup for common NAS types">
            <option value="">-- Select a template --</option>
            <option value="synology">Synology NAS</option>
            <option value="qnap">QNAP NAS</option>
            <option value="windows">Windows Share</option>
            <option value="generic">Generic SMB/CIFS</option>
          </select>
        </div>
        <table class="table table-sm" id="network-targets-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>UNC Path</th>
              <th>Credential Key</th>
              <th style="width:80px">Actions</th>
            </tr>
          </thead>
          <tbody id="network-targets-tbody"></tbody>
        </table>
        <hr class="mt-2 mb-2"/>
        <div class="row g-2">
          <div class="col-md-4">
            <input id="nt-name" class="form-control form-control-sm" placeholder="Name" title="Reference name for the network target">
            <div class="invalid-feedback">Name is required.</div>
          </div>
          <div class="col-md-5">
            <input id="nt-path" class="form-control form-control-sm" placeholder="\\\\NAS\\Share\\Downloads" title="UNC path to the NAS/SMB share">
            <div class="invalid-feedback">Provide a valid UNC path, e.g., \\server\\share\\folder</div>
          </div>
          <div class="col-md-3">
            <input id="nt-cred" class="form-control form-control-sm" placeholder="credential_key" title="Key to credentials in config">
            <div class="invalid-feedback">Credential key is required.</div>
          </div>
        </div>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-primary btn-sm" onclick="addNetworkTarget()" title="Add or update network target">Save Target</button>
          <button class="btn btn-info btn-sm" onclick="testNAS()" title="Test selected network target">Test NAS</button>
          <button class="btn btn-success btn-sm" onclick="saveNetworkConfig()" title="Persist network targets and credentials to organizer config">Persist Network Config</button>
        </div>
        <div class="mt-2">
          <small class="text-muted">Credentials are referenced by key. Configure below in SMTP & Credentials.</small>
        </div>
      </div>
    </div>
  </div>
  
  <!-- SMTP & Credentials -->
  <div class="config-module" data-module="smtp-creds" draggable="true">
    <div class="card" data-right="manage_config">
      <div class="card-header d-flex align-items-center">
        <b>SMTP & Credentials</b>
        <span class="drag-handle ms-auto" style="cursor: move; padding: 4px 10px; font-size: 1.1rem; color: #6c757d;"><i class="bi bi-grip-vertical"></i></span>
      </div>
      <div class="card-body p-2">
        <div class="mb-2">
          <label class="form-label mb-1"><small><b>SMTP Template</b></small></label>
          <select class="form-select form-select-sm" id="smtp-template" onchange="applySMTPTemplate()" title="Quick setup for common email providers">
            <option value="">-- Select a template --</option>
            <option value="gmail">Gmail</option>
            <option value="outlook">Outlook.com</option>
            <option value="office365">Office 365</option>
            <option value="yahoo">Yahoo Mail</option>
            <option value="generic">Generic SMTP</option>
          </select>
        </div>
        <div class="row g-2">
          <div class="col-md-3">
            <input id="smtp-host" class="form-control form-control-sm" placeholder="SMTP Host" title="Mail server hostname">
            <div class="invalid-feedback">SMTP host is required.</div>
          </div>
          <div class="col-md-2">
            <input id="smtp-port" type="number" class="form-control form-control-sm" placeholder="587" title="SMTP port">
            <div class="invalid-feedback">Port must be between 1 and 65535.</div>
          </div>
          <div class="col-md-3">
            <input id="smtp-from" class="form-control form-control-sm" placeholder="from@example.com" title="Sender address">
            <div class="invalid-feedback">Enter a valid email address.</div>
          </div>
          <div class="col-md-4">
            <input id="smtp-to" class="form-control form-control-sm" placeholder="to@example.com" title="Recipient address (comma-separated)">
            <div class="invalid-feedback">Enter one or more valid email addresses.</div>
          </div>
          <div class="col-md-3"><input id="smtp-user" class="form-control form-control-sm" placeholder="Username" title="SMTP username"></div>
          <div class="col-md-3"><input id="smtp-pass" type="password" class="form-control form-control-sm" placeholder="Password" title="SMTP password"></div>
          <div class="col-md-2 form-check d-flex align-items-center ms-2">
            <input class="form-check-input" type="checkbox" id="smtp-tls" checked title="Use STARTTLS">
            <label class="form-check-label ms-1"><small>TLS</small></label>
          </div>
        </div>
        <hr class="mt-2 mb-2"/>
        <div class="mb-2"><b>Stored Credentials</b> <small class="text-muted">(Base64 password; consider OS vault for production)</small></div>
        <table class="table table-sm" id="credentials-table">
          <thead>
            <tr>
              <th>Key</th>
              <th>Username</th>
              <th>Password (base64)</th>
              <th style="width:80px">Actions</th>
            </tr>
          </thead>
          <tbody id="credentials-tbody"></tbody>
        </table>
        <div class="row g-2">
          <div class="col-md-3">
            <input id="cred-key" class="form-control form-control-sm" placeholder="nas_default" title="Credential key">
            <div class="invalid-feedback">Credential key is required.</div>
          </div>
          <div class="col-md-3"><input id="cred-user" class="form-control form-control-sm" placeholder="user" title="Username"></div>
          <div class="col-md-6">
            <input id="cred-pass-b64" class="form-control form-control-sm" placeholder="cGFzc3dvcmQ=" title="Base64-encoded password">
            <div class="invalid-feedback">Password must be base64-encoded.</div>
          </div>
        </div>
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-primary btn-sm" onclick="addCredential()" title="Add or update credential">Save Credential</button>
          <button class="btn btn-info btn-sm" onclick="testSMTP()" title="Send a test email">Test SMTP</button>
          <button class="btn btn-success btn-sm" onclick="saveSmtpAndCredentials()" title="Persist SMTP and credentials">Persist SMTP & Credentials</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Watched Folders -->
  <div class="config-module" data-module="watched-folders" draggable="true">
    <div class="card" data-right="manage_config">
      <div class="card-header d-flex align-items-center">
        <b>Watched Folders</b>
        <span class="drag-handle ms-auto" style="cursor: move; padding: 4px 10px; font-size: 1.1rem; color: #6c757d;"><i class="bi bi-grip-vertical"></i></span>
      </div>
      <div class="card-body p-2">
        <div class="input-group mb-2">
          <input type="text" class="form-control" id="watch-folder-input" placeholder="Add folder path (e.g., C:/Users/you/Downloads)">
          <button class="btn btn-outline-primary" type="button" onclick="addWatchFolder()"><i class="bi bi-plus"></i> Add</button>
          <button class="btn btn-outline-success" type="button" onclick="saveWatchFolders()"><i class="bi bi-save"></i> Save</button>
          <button class="btn btn-outline-secondary" type="button" onclick="testSelectedWatchFolder()"><i class="bi bi-check2-circle"></i> Test Selected</button>
          <button class="btn btn-outline-info" type="button" onclick="openConfigActions()"><i class="bi bi-journal-text"></i> View Config Actions</button>
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="checkbox" id="wf-create-missing">
          <label class="form-check-label" for="wf-create-missing"><small>Create folder if missing (with confirmation)</small></label>
        </div>
        <ul class="list-group" id="watch-folders-config-list"></ul>
        <small class="text-muted d-block mt-1">These folders will be monitored and organized into category subfolders.</small>
        <small class="text-muted d-block">Accepted formats: UNC (`\\\\server\\share\\path`), Windows absolute (`C:/path` or `C:\\path`), Unix absolute (`/path`). Placeholders `%USERNAME%` and `%USER%` are supported and resolved at runtime.</small>
      </div>
    </div>
  </div>

  <!-- Config Actions Modal -->
  <div class="modal fade" id="configActionsModal" tabindex="-1" aria-labelledby="configActionsLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="configActionsLabel">Recent Configuration Actions</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="config-actions-body">
            <div class="text-muted">No audit entries</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Custom Branding & Styles -->
  <div class="config-module full-width" data-module="branding" draggable="true">
    <div class="card" data-right="manage_config">
      <div class="card-header d-flex align-items-center">
        <b>Custom Branding & Styles</b>
        <span class="drag-handle ms-auto" style="cursor: move; padding: 4px 10px; font-size: 1.1rem; color: #6c757d;"><i class="bi bi-grip-vertical"></i></span>
      </div>
      <div class="card-body p-2">
        <div class="row g-2">
          <div class="col-md-4">
            <label class="form-label mb-1"><small><b>Dashboard Title</b></small></label>
            <input id="brand-title" class="form-control form-control-sm" placeholder="DownloadsOrganizeR" title="Custom dashboard title">
          </div>
          <div class="col-md-4">
            <label class="form-label mb-1"><small><b>Logo URL</b></small></label>
            <input id="brand-logo" class="form-control form-control-sm" placeholder="https://example.com/logo.png" title="URL to custom logo image">
          </div>
          <div class="col-md-4">
            <label class="form-label mb-1"><small><b>Primary Color</b></small></label>
            <input id="brand-color" type="color" class="form-control form-control-sm form-control-color" value="#0d6efd" title="Primary brand color">
          </div>
        </div>
        <div class="mt-2">
          <label class="form-label mb-1"><small><b>Custom CSS</b></small></label>
          <textarea id="brand-css" class="form-control form-control-sm" rows="6" placeholder="/* Add custom CSS here */" title="Custom CSS styles applied to dashboard"></textarea>
          <small class="text-muted">Advanced: Add custom CSS to override dashboard styles. Use with caution.</small>
        </div>
        <div class="mt-2">
          <button class="btn btn-success btn-sm" onclick="saveBranding()">Save Branding</button>
          <button class="btn btn-secondary btn-sm" onclick="resetBranding()">Reset to Default</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Logs (Real-time) -->
  <div class="config-module full-width" data-module="logs" draggable="true">
    <div class="card">
      <div class="card-header d-flex align-items-center">
        <b>Logs (Real-time)</b>
        <span class="drag-handle ms-auto" style="cursor: move; padding: 4px 10px; font-size: 1.1rem; color: #6c757d;"><i class="bi bi-grip-vertical"></i></span>
      </div>
      <div class="card-body p-2">
        <div class="mb-2">
          <div class="input-group input-group-sm">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="search-logs" placeholder="Search logs (highlights matching lines)..." oninput="filterLogs()">
            <button class="btn btn-outline-secondary" onclick="clearLogSearch()" title="Clear search">
              <i class="bi bi-x-lg"></i>
            </button>
          </div>
        </div>
        <div class="row g-2">
          <div class="col-md-6">
            <div class="mb-1"><b>Stdout Log</b></div>
            <button class="btn btn-secondary btn-sm mb-1" onclick="clearLog('stdout')">Clear Log</button>
            <pre id="stdout-log" style="max-height: 300px; overflow-y: auto; font-size: 0.85rem;"></pre>
          </div>
          <div class="col-md-6">
            <div class="mb-1"><b>Stderr Log</b></div>
            <button class="btn btn-secondary btn-sm mb-1" onclick="clearLog('stderr')">Clear Log</button>
            <pre id="stderr-log" style="max-height: 300px; overflow-y: auto; font-size: 0.85rem;"></pre>
          </div>
        </div>
      </div>
    </div>
  </div>
  
</div>
{% include "dashboard_scripts.html" %}
<script>
let dashboardConfig = null;
function fetchConfig() {
  fetch('/api/dashboard/config', {headers: getAuthHeaders()})
    .then(r => { if(!r.ok) throw new Error('Failed'); return r.json(); })
    .then(data => {
      dashboardConfig = data;
      renderUsers(data.users);
      renderRoles(Object.keys(data.roles));
      renderLayout(data.layout);
      renderNetworkTargets(data.network_targets || {});
      renderCredentials(data.credentials || {});
      renderSmtp(data.smtp || {});
    })
    .catch(err => showNotification('Load failed: ' + err.message, 'danger'));
}
function renderUsers(users){
  const tbody = document.getElementById('users-tbody');
  tbody.innerHTML = users.map(u => {
    return `<tr><td><small>${u.username}</small></td><td><small>${u.role}</small></td><td><button class='btn btn-sm btn-danger' onclick="deleteUser('${u.username}')">Del</button></td></tr>`;
  }).join('');
  // Reapply rights after rendering dynamic content
  if (typeof applyConfigRights === 'function') {
    applyConfigRights();
  }
}
function renderRoles(roleNames){
  const sel = document.getElementById('new-role');
  sel.innerHTML = roleNames.map(r => `<option value='${r}'>${r}</option>`).join('');
}
function saveUser(){
  const username = document.getElementById('new-username').value.trim();
  const role = document.getElementById('new-role').value.trim();
  const password = document.getElementById('new-password').value;
  if(!username || !role){ showNotification('Username and role required', 'warning'); return; }
  fetch('/api/dashboard/users', {method:'POST', headers: {'Content-Type':'application/json', ...getAuthHeaders()}, body: JSON.stringify({username, role, password: password || undefined})})
    .then(r=>r.json().then(j=>({ok:r.ok, j})))
    .then(({ok,j})=>{ if(ok){ showNotification('User saved', 'success'); document.getElementById('new-password').value=''; fetchConfig(); } else { showNotification(j.error||'Save failed','danger'); } });
}
function deleteUser(username){
  if(!confirm('Delete user ' + username + '?')) return;
  fetch('/api/dashboard/users/' + encodeURIComponent(username), {method:'DELETE', headers: getAuthHeaders()})
    .then(r=>r.json().then(j=>({ok:r.ok,j})))
    .then(({ok,j})=>{ if(ok){ showNotification('User deleted', 'success'); fetchConfig(); } else { showNotification(j.error||'Delete failed','danger'); } });
}
function renderLayout(layout){
  const list = document.getElementById('sections-list');
  const order = layout.sections_order || [];
  const hidden = new Set(layout.hidden_sections || []);
  list.innerHTML = order.map(sec => {
    const checked = hidden.has(sec) ? 'checked' : '';
    return `<li class='list-group-item d-flex align-items-center' draggable='true' ondragstart='dragStart(event)' ondragover='dragOver(event)' ondrop='dropItem(event)'>
      <span class='me-2 text-muted' style='cursor:grab'>&#9776;</span>
      <input type='checkbox' class='form-check-input me-2' data-section='${sec}' ${checked} />
      <span>${sec}</span>
    </li>`;
  }).join('');
  // Reapply rights after rendering dynamic content
  if (typeof applyConfigRights === 'function') {
    applyConfigRights();
  }
}

// Config page drag-and-drop
let configDraggedElement = null;

function initConfigDragDrop() {
  const modules = document.querySelectorAll('.config-module[draggable="true"]');
  modules.forEach(module => {
    module.addEventListener('dragstart', handleConfigDragStart);
    module.addEventListener('dragover', handleConfigDragOver);
    module.addEventListener('dragenter', handleConfigDragEnter);
    module.addEventListener('dragleave', handleConfigDragLeave);
    module.addEventListener('drop', handleConfigDrop);
    module.addEventListener('dragend', handleConfigDragEnd);
  });
}

function handleConfigDragStart(e) {
  configDraggedElement = this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
  setTimeout(() => {
    document.querySelectorAll('.config-module:not(.dragging)').forEach(m => m.style.opacity = '0.7');
  }, 0);
}

function handleConfigDragOver(e) {
  if (e.preventDefault) e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  return false;
}

function handleConfigDragEnter(e) {
  if (this === configDraggedElement) return;
  this.classList.add('drag-over');
}

function handleConfigDragLeave(e) {
  if (this === configDraggedElement) return;
  this.classList.remove('drag-over');
}

function handleConfigDrop(e) {
  if (e.stopPropagation) e.stopPropagation();
  this.classList.remove('drag-over');
  
  if (configDraggedElement && configDraggedElement !== this) {
    const grid = document.getElementById('config-grid');
    const allModules = Array.from(grid.children).filter(el => el.classList.contains('config-module'));
    const draggedIndex = allModules.indexOf(configDraggedElement);
    const targetIndex = allModules.indexOf(this);
    
    if (draggedIndex < targetIndex) {
      this.parentNode.insertBefore(configDraggedElement, this.nextSibling);
    } else {
      this.parentNode.insertBefore(configDraggedElement, this);
    }
    
    saveConfigLayout();
  }
  return false;
}

function handleConfigDragEnd(e) {
  this.classList.remove('dragging');
  document.querySelectorAll('.config-module').forEach(m => {
    m.style.opacity = '1';
    m.classList.remove('drag-over');
  });
}

function saveConfigLayout() {
  const grid = document.getElementById('config-grid');
  const layout = Array.from(grid.children).map(el => el.dataset.module).filter(m => m);
  localStorage.setItem('configLayout_' + (__authHeader || 'default'), JSON.stringify(layout));
}

function loadConfigLayout() {
  const savedLayout = localStorage.getItem('configLayout_' + (__authHeader || 'default'));
  if (!savedLayout) return;
  
  try {
    const layout = JSON.parse(savedLayout);
    const grid = document.getElementById('config-grid');
    if (!grid) return;
    
    layout.forEach(moduleId => {
      const module = grid.querySelector(`[data-module="${moduleId}"]`);
      if (module) grid.appendChild(module);
    });
  } catch (e) {
    console.error('Error loading config layout:', e);
  }
}

// Custom branding functions
function saveBranding() {
  const branding = {
    title: document.getElementById('brand-title').value,
    logo: document.getElementById('brand-logo').value,
    color: document.getElementById('brand-color').value,
    css: document.getElementById('brand-css').value
  };
  
  fetch('/api/dashboard/branding', {
    method: 'POST',
    headers: {'Content-Type': 'application/json', ...getAuthHeaders()},
    body: JSON.stringify(branding)
  })
  .then(r => r.json().then(j => ({ok: r.ok, j})))
  .then(({ok, j}) => {
    if (ok) {
      showNotification('Branding saved successfully', 'success');
      applyBranding(branding);
    } else {
      showNotification(j.error || 'Failed to save branding', 'danger');
    }
  });
}

function resetBranding() {
  if (confirm('Reset branding to defaults?')) {
    document.getElementById('brand-title').value = 'DownloadsOrganizeR';
    document.getElementById('brand-logo').value = '';
    document.getElementById('brand-color').value = '#0d6efd';
    document.getElementById('brand-css').value = '';
    saveBranding();
  }
}

function loadBranding() {
  fetch('/api/dashboard/branding', {headers: getAuthHeaders()})
    .then(r => r.ok ? r.json() : {})
    .then(branding => {
      if (branding.title) document.getElementById('brand-title').value = branding.title;
      if (branding.logo) document.getElementById('brand-logo').value = branding.logo;
      if (branding.color) document.getElementById('brand-color').value = branding.color;
      if (branding.css) document.getElementById('brand-css').value = branding.css;
      applyBranding(branding);
    });
}

function applyBranding(branding) {
  if (branding.css) {
    let style = document.getElementById('custom-branding-css');
    if (!style) {
      style = document.createElement('style');
      style.id = 'custom-branding-css';
      document.head.appendChild(style);
    }
    style.textContent = branding.css;
  }
}

// ---- Validation helpers ----
function setInvalid(id, msg){
  const el = document.getElementById(id);
  if(!el) return false;
  el.classList.add('is-invalid');
  const fb = el.parentElement.querySelector('.invalid-feedback');
  if(fb && msg) fb.textContent = msg;
  return false;
}
function clearInvalid(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.classList.remove('is-invalid');
}
function isValidUNC(p){
  // \\server\share or \\server\share\path
  return /^\\\\[^\\\/]+\\[^\\\/]+(\\.*)?$/.test(p || '');
}
function isValidEmail(e){
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test((e||'').trim());
}
function validateEmails(list){
  const items = (list||'').split(/[,;]+/).map(s=>s.trim()).filter(Boolean);
  return items.length>0 && items.every(isValidEmail);
}
function isValidBase64(s){
  if(!s) return true; // allow empty
  try { atob(s); return true; } catch(e){ return false; }
}
// Initialize
document.addEventListener('DOMContentLoaded', () => {
  // Restore auth from sessionStorage if not already set
  if (typeof __authHeader === 'undefined' || !__authHeader) {
    try {
      const storedAuth = sessionStorage.getItem('authHeader');
      if (storedAuth) {
        __authHeader = storedAuth;
      }
    } catch (e) {
      console.warn('sessionStorage not available:', e);
    }
  }
  
  // Verify auth and load rights if we have credentials
  if (__authHeader) {
    fetch('/auth_check', {
      credentials: 'include',
      headers: { 'Authorization': __authHeader }
    }).then(response => {
      if (response.ok) {
        return response.json();
      } else {
        throw new Error('Auth check failed');
      }
    }).then(data => {
      __rights = data.rights || {};
      __configVersion = data.config_version || 0;
      applyConfigRights();
      // Fetch config AFTER rights are loaded to avoid race condition
      fetchConfig();
      // Initialize config page features
      initConfigDragDrop();
      loadConfigLayout();
      loadBranding();
      // Start log streaming
      if (__rights.view_metrics) {
        streamLog('stdout');
        streamLog('stderr');
      }
      // Load watched folders config
      loadWatchFoldersConfig();
    }).catch(err => {
      console.error('Auth check failed:', err);
      showNotification('Authentication failed. Please login again.', 'danger');
      setTimeout(() => { window.location.href = '/'; }, 2000);
    });
  } else {
    showNotification('Not logged in. Redirecting...', 'warning');
    setTimeout(() => { window.location.href = '/'; }, 2000);
  }
});

// Helper function to safely parse JSON responses
async function parseResponse(response) {
  const contentType = response.headers.get('content-type');
  if (contentType && contentType.includes('application/json')) {
    try {
      const json = await response.json();
      return { ok: response.ok, status: response.status, json };
    } catch (e) {
      return { ok: false, status: response.status, error: 'Invalid JSON response' };
    }
  } else {
    const text = await response.text();
    return { ok: response.ok, status: response.status, text };
  }
}

// Global functions that need to be accessible from onclick handlers
function resetSetup(){
  if(!confirm('Re-run setup wizard? Users will be redirected to setup page and must complete it again to access dashboard.')) return;
  fetch('/api/setup/reset', {method:'POST', headers: getAuthHeaders()})
    .then(r=>r.json().then(j=>({ok:r.ok,j})))
    .then(({ok,j})=>{ if(ok && j.success){ showNotification('Setup reset. Redirecting to wizard...', 'success'); setTimeout(()=>{ window.location.href='/setup'; },1500); } else { showNotification(j.error||'Reset failed','danger'); } });
}

async function installService() {
  if (!confirm('Install the Organizer service? Requires administrator privileges.')) return;
  const serviceName = document.getElementById('service-name-input').value.trim();
  const scriptsRoot = document.getElementById('scripts-root-input').value.trim();
  const memoryThreshold = parseInt(document.getElementById('memory-threshold-input').value);
  const cpuThreshold = parseInt(document.getElementById('cpu-threshold-input').value);
  showNotification('Installing service... This may take a minute.', 'info');
  
  try {
    const response = await fetch('/api/service/install', {
      method: 'POST', 
      headers: {'Content-Type': 'application/json', ...getAuthHeaders()}, 
      body: JSON.stringify({service_name: serviceName, scripts_root: scriptsRoot, memory_threshold_mb: memoryThreshold, cpu_threshold_percent: cpuThreshold})
    });
    
    const result = await parseResponse(response);
    
    if (result.status === 401 || result.status === 403) {
      showNotification('Authentication required. Please login again.', 'warning');
      return;
    }
    
    if (result.json) {
      if (result.ok && result.json.success) {
        showNotification('Service installed successfully!', 'success');
        if (result.json.output) console.log('Install:', result.json.output);
      } else {
        showNotification(result.json.error || 'Installation failed', 'danger');
        if (result.json.error_output) console.error('Install error:', result.json.error_output);
      }
    } else {
      showNotification(result.text || 'Installation failed', 'danger');
    }
  } catch (err) {
    showNotification('Installation error: ' + err.message, 'danger');
  }
}

async function uninstallService() {
  if (!confirm('Uninstall the Organizer service? This will stop and remove it.')) return;
  const serviceName = document.getElementById('service-name-input').value.trim();
  showNotification('Uninstalling service...', 'info');
  
  try {
    const response = await fetch('/api/service/uninstall', {
      method: 'POST', 
      headers: {'Content-Type': 'application/json', ...getAuthHeaders()}, 
      body: JSON.stringify({service_name: serviceName})
    });
    
    const result = await parseResponse(response);
    
    if (result.status === 401 || result.status === 403) {
      showNotification('Authentication required. Please login again.', 'warning');
      return;
    }
    
    if (result.json) {
      if (result.ok && result.json.success) {
        showNotification('Service uninstalled successfully!', 'success');
      } else {
        showNotification(result.json.error || 'Uninstallation failed', 'danger');
      }
    } else {
      showNotification(result.text || 'Uninstallation failed', 'danger');
    }
  } catch (err) {
    showNotification('Uninstallation error: ' + err.message, 'danger');
  }
}

async function reinstallService() {
  if (!confirm('Reinstall the Organizer service? Will uninstall and reinstall with current settings.')) return;
  const serviceName = document.getElementById('service-name-input').value.trim();
  const scriptsRoot = document.getElementById('scripts-root-input').value.trim();
  const memoryThreshold = parseInt(document.getElementById('memory-threshold-input').value);
  const cpuThreshold = parseInt(document.getElementById('cpu-threshold-input').value);
  showNotification('Reinstalling service... This may take a minute.', 'info');
  
  try {
    const response = await fetch('/api/service/reinstall', {
      method: 'POST', 
      headers: {'Content-Type': 'application/json', ...getAuthHeaders()}, 
      body: JSON.stringify({service_name: serviceName, scripts_root: scriptsRoot, memory_threshold_mb: memoryThreshold, cpu_threshold_percent: cpuThreshold})
    });
    
    const result = await parseResponse(response);
    
    if (result.status === 401 || result.status === 403) {
      showNotification('Authentication required. Please login again.', 'warning');
      return;
    }
    
    if (result.json) {
      if (result.ok && result.json.success) {
        showNotification('Service reinstalled successfully!', 'success');
        if (result.json.output) console.log('Reinstall:', result.json.output);
      } else {
        showNotification(result.json.error || 'Reinstallation failed', 'danger');
        if (result.json.error_output) console.error('Reinstall error:', result.json.error_output);
      }
    } else {
      showNotification(result.text || 'Reinstallation failed', 'danger');
    }
  } catch (err) {
    showNotification('Reinstallation error: ' + err.message, 'danger');
  }
}

function factoryReset() {
  if (!confirm('⚠️ WARNING: Reset ALL configurations to defaults?\\n\\nIncludes:\\n- File organization rules\\n- User accounts (except admin)\\n- Dashboard layout\\n- All settings\\n\\nCannot be undone!')) return;
  if (!confirm('Are you absolutely sure? This will erase all custom configurations!')) return;
  showNotification('Performing factory reset...', 'info');
  fetch('/api/factory-reset', {method: 'POST', headers: {'Content-Type': 'application/json', ...getAuthHeaders()}})
    .then(r => r.json().then(j => ({ok: r.ok, j})))
    .then(({ok, j}) => { if (ok && j.success) { showNotification('Factory reset complete! Redirecting...', 'success'); setTimeout(() => { window.location.href = '/'; }, 2000); } else { showNotification(j.error || 'Factory reset failed', 'danger'); } })
    .catch(err => showNotification('Factory reset error: ' + err.message, 'danger'));
}

async function repairAuth() {
  const username = (document.getElementById('new-username')?.value || '').trim();
  const password = (document.getElementById('new-password')?.value || '').trim();
  const body = { username: username || undefined, password: password || undefined, force_basic: true };
  showNotification('Repairing auth...', 'info');
  try {
    const resp = await fetch('/api/admin/repair_auth', {
      method: 'POST',
      credentials: 'include',
      headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
      body: JSON.stringify(body)
    });
    const data = await resp.json();
    if (resp.ok && data.success) {
      showNotification('Auth repaired for ' + data.username, 'success');
      fetchConfig();
    } else {
      showNotification(data.error || 'Auth repair failed', 'danger');
    }
  } catch (e) {
    showNotification('Auth repair error: ' + e.message, 'danger');
  }
}

async function viewAuthState() {
  try {
    const resp = await fetch('/api/admin/auth_state', { credentials: 'include', headers: getAuthHeaders() });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.error || 'Failed to fetch auth state');
    const msg = `User: ${data.dashboard_user}\nMethod: ${data.auth_method}\nFallback: ${data.auth_fallback_enabled}\nSetup: ${data.setup_completed}\nUsers: ${data.users.map(u=>u.username+':' + u.role + ' (hash=' + (u.has_hash?'yes':'no') + ')').join(', ')}`;
    showNotification(msg.replaceAll('\n','<br/>'), 'info');
  } catch (e) {
    showNotification('Auth state error: ' + e.message, 'danger');
  }
}

function applyConfigRights() {
  if (!__rights.manage_config) {
    // Disable all user management controls (table buttons, input fields, and save button)
    document.querySelectorAll('#users-table button, #new-username, #new-role, #new-password, button[onclick="saveUser()"]').forEach(el => { 
      if(el) {
        el.disabled = true;
        if (el.tagName === 'BUTTON') {
          el.title = 'Insufficient rights (manage_config)';
        }
      }
    });
  }
  if (!__rights.modify_layout) {
    const saveBtn = document.querySelector('#layout-editor button.btn-success');
    if (saveBtn) { saveBtn.disabled = true; saveBtn.title = 'Insufficient rights (modify_layout)'; }
    // Disable drag by removing draggable attributes
    document.querySelectorAll('#sections-list li').forEach(li => li.removeAttribute('draggable'));
  }
  if (!__rights.manage_service) {
    document.querySelectorAll('#service-name-input, #scripts-root-input, #memory-threshold-input, #cpu-threshold-input').forEach(el => {
      if (el) el.disabled = true;
    });
    document.querySelectorAll('button[onclick^="installService"], button[onclick^="reinstallService"], button[onclick^="uninstallService"]').forEach(el => {
      if (el) { el.disabled = true; el.title = 'Insufficient rights (manage_service)'; }
    });
  }
  if (!__rights.manage_config) {
    const resetBtn = document.querySelector('button[onclick="factoryReset()"]');
    if (resetBtn) resetBtn.style.display = 'none';
  }
}

function renderNetworkTargets(targets){
  const tbody = document.getElementById('network-targets-tbody');
  const rows = Object.entries(targets).map(([name, cfg]) => {
    const path = (cfg && cfg.path) || '';
    const credential_key = (cfg && cfg.credential_key) || '';
    return `<tr>
      <td><small>${name}</small></td>
      <td><small>${path}</small></td>
      <td><small>${credential_key}</small></td>
      <td><button class='btn btn-sm btn-danger' onclick="deleteNetworkTarget('${name}')" title="Delete target">Del</button></td>
    </tr>`;
  }).join('');
  tbody.innerHTML = rows;
}
function addNetworkTarget(){
  const name = document.getElementById('nt-name').value.trim();
  const path = document.getElementById('nt-path').value.trim();
  const credential_key = document.getElementById('nt-cred').value.trim();
  clearInvalid('nt-name'); clearInvalid('nt-path'); clearInvalid('nt-cred');
  if(!name){ return setInvalid('nt-name', 'Name is required.'); }
  if(!isValidUNC(path)){ return setInvalid('nt-path', 'Provide a valid UNC path, e.g., \\server\\share'); }
  if(!credential_key){ return setInvalid('nt-cred', 'Credential key is required.'); }
  dashboardConfig.network_targets = dashboardConfig.network_targets || {};
  dashboardConfig.network_targets[name] = { path, credential_key };
  renderNetworkTargets(dashboardConfig.network_targets);
}
function deleteNetworkTarget(name){
  if(!confirm('Delete network target '+name+'?')) return;
  if(dashboardConfig.network_targets){ delete dashboardConfig.network_targets[name]; }
  renderNetworkTargets(dashboardConfig.network_targets||{});
}
function saveNetworkConfig(){
  // Ensure there is at least one target when saving (optional)
  const payload = { network_targets: dashboardConfig.network_targets || {}, credentials: dashboardConfig.credentials || {} };
  fetch('/api/dashboard/update-config', {method:'POST', headers:{'Content-Type':'application/json', ...getAuthHeaders()}, body: JSON.stringify(payload)})
    .then(r=>r.json().then(j=>({ok:r.ok,j})))
    .then(({ok,j})=>{ if(ok){ showNotification('Network config saved','success'); } else { showNotification(j.error||'Save failed','danger'); } });
}

function renderCredentials(creds){
  const tbody = document.getElementById('credentials-tbody');
  const rows = Object.entries(creds).map(([key, c]) => {
    return `<tr>
      <td><small>${key}</small></td>
      <td><small>${c.username||''}</small></td>
      <td><small>${c.password_b64||''}</small></td>
      <td><button class='btn btn-sm btn-danger' onclick="deleteCredential('${key}')" title="Delete credential">Del</button></td>
    </tr>`;
  }).join('');
  tbody.innerHTML = rows;
}
function addCredential(){
  const key = document.getElementById('cred-key').value.trim();
  const username = document.getElementById('cred-user').value.trim();
  const password_b64 = document.getElementById('cred-pass-b64').value.trim();
  clearInvalid('cred-key'); clearInvalid('cred-pass-b64');
  if(!key){ return setInvalid('cred-key', 'Credential key is required.'); }
  if(password_b64 && !isValidBase64(password_b64)){ return setInvalid('cred-pass-b64', 'Password must be base64-encoded.'); }
  dashboardConfig.credentials = dashboardConfig.credentials || {};
  dashboardConfig.credentials[key] = { username, password_b64 };
  renderCredentials(dashboardConfig.credentials);
}
function deleteCredential(key){
  if(!confirm('Delete credential '+key+'?')) return;
  if(dashboardConfig.credentials){ delete dashboardConfig.credentials[key]; }
  renderCredentials(dashboardConfig.credentials||{});
}
function renderSmtp(smtp){
  document.getElementById('smtp-host').value = smtp.host || '';
  document.getElementById('smtp-port').value = smtp.port || 587;
  document.getElementById('smtp-from').value = smtp.from || '';
  document.getElementById('smtp-to').value = smtp.to || '';
  document.getElementById('smtp-user').value = smtp.username || '';
  document.getElementById('smtp-pass').value = smtp.password || '';
  document.getElementById('smtp-tls').checked = (smtp.tls !== false);
}
function saveSmtpAndCredentials(){
  const smtp = {
    host: document.getElementById('smtp-host').value.trim(),
    port: parseInt(document.getElementById('smtp-port').value) || 587,
    from: document.getElementById('smtp-from').value.trim(),
    to: document.getElementById('smtp-to').value.trim(),
    username: document.getElementById('smtp-user').value.trim(),
    password: document.getElementById('smtp-pass').value,
    tls: document.getElementById('smtp-tls').checked
  };
  // Validate SMTP fields
  clearInvalid('smtp-host'); clearInvalid('smtp-port'); clearInvalid('smtp-from'); clearInvalid('smtp-to');
  if(!smtp.host){ return setInvalid('smtp-host', 'SMTP host is required.'); }
  if(!(smtp.port>=1 && smtp.port<=65535)){ return setInvalid('smtp-port', 'Port must be between 1 and 65535.'); }
  if(!isValidEmail(smtp.from)){ return setInvalid('smtp-from', 'Enter a valid email address.'); }
  if(!validateEmails(smtp.to)){ return setInvalid('smtp-to', 'Enter one or more valid email addresses.'); }
  const payload = { smtp, credentials: dashboardConfig.credentials || {} };
  fetch('/api/dashboard/update-config', {method:'POST', headers:{'Content-Type':'application/json', ...getAuthHeaders()}, body: JSON.stringify(payload)})
    .then(r=>r.json().then(j=>({ok:r.ok,j})))
    .then(({ok,j})=>{ if(ok){ showNotification('SMTP & credentials saved','success'); } else { showNotification(j.error||'Save failed','danger'); } });
}
function testSMTP(){
  const smtp = {
    host: document.getElementById('smtp-host').value.trim(),
    port: parseInt(document.getElementById('smtp-port').value) || 587,
    from: document.getElementById('smtp-from').value.trim(),
    to: document.getElementById('smtp-to').value.trim(),
    username: document.getElementById('smtp-user').value.trim(),
    password: document.getElementById('smtp-pass').value,
    tls: document.getElementById('smtp-tls').checked
  };
  clearInvalid('smtp-host'); clearInvalid('smtp-port'); clearInvalid('smtp-from'); clearInvalid('smtp-to');
  if(!smtp.host){ return setInvalid('smtp-host', 'SMTP host is required.'); }
  if(!(smtp.port>=1 && smtp.port<=65535)){ return setInvalid('smtp-port', 'Port must be between 1 and 65535.'); }
  if(!isValidEmail(smtp.from)){ return setInvalid('smtp-from', 'Enter a valid email address.'); }
  if(!validateEmails(smtp.to)){ return setInvalid('smtp-to', 'Enter one or more valid email addresses.'); }
  showNotification('Sending test email...', 'info');
  fetch('/api/test/smtp', {method:'POST', headers:{'Content-Type':'application/json', ...getAuthHeaders()}, body: JSON.stringify(smtp)})
    .then(r=>r.json().then(j=>({ok:r.ok,j})))
    .then(({ok,j})=>{ if(ok){ showNotification(j.message||'SMTP test succeeded','success'); } else { showNotification(j.error||'SMTP test failed','danger'); } })
    .catch(e=>showNotification('SMTP test error: '+e.message,'danger'));
}
function testNAS(){
  const path = document.getElementById('nt-path').value.trim();
  const credential_key = document.getElementById('nt-cred').value.trim();
  clearInvalid('nt-path');
  if(!isValidUNC(path)){ return setInvalid('nt-path', 'Provide a valid UNC path.'); }
  showNotification('Testing NAS path...', 'info');
  fetch('/api/test/nas', {method:'POST', headers:{'Content-Type':'application/json', ...getAuthHeaders()}, body: JSON.stringify({path, credential_key})})
    .then(r=>r.json().then(j=>({ok:r.ok,j})))
    .then(({ok,j})=>{ if(ok){ showNotification(j.message||'NAS test succeeded','success'); } else { showNotification(j.error||'NAS test failed','danger'); } })
    .catch(e=>showNotification('NAS test error: '+e.message,'danger'));
}

function applyNASTemplate(){
  const template = document.getElementById('nas-template').value;
  if(!template) return;
  const templates = {
    synology: {
      name: 'synology_nas',
      path: '\\\\synology.local\\downloads',
      credential_key: 'synology_admin',
      hint: 'Replace synology.local with your NAS hostname/IP'
    },
    qnap: {
      name: 'qnap_nas',
      path: '\\\\qnap.local\\Public\\Downloads',
      credential_key: 'qnap_admin',
      hint: 'Replace qnap.local with your NAS hostname/IP'
    },
    windows: {
      name: 'windows_share',
      path: '\\\\SERVER\\SharedFolder',
      credential_key: 'domain_user',
      hint: 'Replace SERVER and SharedFolder with your share details'
    },
    generic: {
      name: 'nas_target',
      path: '\\\\192.168.1.100\\share',
      credential_key: 'nas_default',
      hint: 'Generic SMB/CIFS share template'
    }
  };
  const t = templates[template];
  if(t){
    document.getElementById('nt-name').value = t.name;
    document.getElementById('nt-path').value = t.path;
    document.getElementById('nt-cred').value = t.credential_key;
    showNotification(t.hint, 'info');
  }
}

function applySMTPTemplate(){
  const template = document.getElementById('smtp-template').value;
  if(!template) return;
  const templates = {
    gmail: {
      host: 'smtp.gmail.com',
      port: 587,
      tls: true,
      hint: 'Gmail requires an App Password (not your account password). Enable 2FA and generate one at myaccount.google.com/apppasswords'
    },
    outlook: {
      host: 'smtp-mail.outlook.com',
      port: 587,
      tls: true,
      hint: 'Outlook.com SMTP settings. Use your full email and password.'
    },
    office365: {
      host: 'smtp.office365.com',
      port: 587,
      tls: true,
      hint: 'Office 365 SMTP. Use your organizational email and password.'
    },
    yahoo: {
      host: 'smtp.mail.yahoo.com',
      port: 587,
      tls: true,
      hint: 'Yahoo Mail requires an App Password. Generate one in Account Security settings.'
    },
    generic: {
      host: 'smtp.example.com',
      port: 587,
      tls: true,
      hint: 'Generic SMTP template. Update host and credentials.'
    }
  };
  const t = templates[template];
  if(t){
    document.getElementById('smtp-host').value = t.host;
    document.getElementById('smtp-port').value = t.port;
    document.getElementById('smtp-tls').checked = t.tls;
    showNotification(t.hint, 'info');
  }
}

// Search/Filter Functions for Config Modules

// Filter Users table
function filterUsers() {
  const searchTerm = document.getElementById('search-users').value.toLowerCase();
  const rows = document.querySelectorAll('#users-tbody tr');
  let visibleCount = 0;
  
  rows.forEach(row => {
    const username = row.cells[0]?.textContent.toLowerCase() || '';
    const role = row.cells[1]?.textContent.toLowerCase() || '';
    
    if (username.includes(searchTerm) || role.includes(searchTerm)) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  });
  function loadWatchFoldersConfig() {
    fetch('/api/watch_folders', { credentials: 'include', headers: { 'Authorization': __authHeader }})
      .then(r => r.json())
      .then(data => {
        const folders = Array.isArray(data.folders) ? data.folders : [];
        const ul = document.getElementById('watch-folders-config-list');
        ul.innerHTML = folders.map((f, idx) => `
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>
              <code>${f}</code>
              <span class="ms-2 ${isValidPath(f) ? 'text-success' : 'text-warning'}" title="${isValidPath(f) ? 'Valid path' : 'Invalid path'}">
                <i class="bi ${isValidPath(f) ? 'bi-check-circle' : 'bi-exclamation-triangle'}"></i>
              </span>
            </span>
            <div class="btn-group">
              <button class="btn btn-sm btn-outline-info" onclick="runInitialScan(${idx})" title="Run initial scan"><i class="bi bi-play"></i></button>
              <button class="btn btn-sm btn-outline-danger" onclick="removeWatchFolder(${idx})" title="Remove"><i class="bi bi-trash"></i></button>
            </div>
          </li>
        `).join('');
        window.__watchFolders = folders;
      }).catch(err => console.error('Failed to load watch folders', err));
  }

  function addWatchFolder() {
    const input = document.getElementById('watch-folder-input');
    const val = (input.value || '').trim();
    if (!val) return;
    window.__watchFolders = Array.isArray(window.__watchFolders) ? window.__watchFolders : [];
    window.__watchFolders.push(val);
    input.value = '';
    renderWatchFoldersList();
  }

  function removeWatchFolder(index) {
    if (!Array.isArray(window.__watchFolders)) return;
    window.__watchFolders.splice(index, 1);
    renderWatchFoldersList();
  }

  function renderWatchFoldersList() {
    const ul = document.getElementById('watch-folders-config-list');
    const folders = Array.isArray(window.__watchFolders) ? window.__watchFolders : [];
    ul.innerHTML = folders.map((f, idx) => {
      const valid = isValidPath(f);
      const badgeClass = valid ? 'text-success' : 'text-warning';
      const badgeIcon = valid ? 'bi-check-circle' : 'bi-exclamation-triangle';
      const title = valid ? 'Valid path' : 'Invalid path';
      const liClass = valid ? 'list-group-item' : 'list-group-item list-group-item-warning';
      return `
      <li class="${liClass} d-flex justify-content-between align-items-center">
        <span>
          <code>${f}</code>
          <span class="ms-2 ${badgeClass}" title="${title}">
            <i class="bi ${badgeIcon}"></i>
          </span>
        </span>
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-info" onclick="runInitialScan(${idx})" title="Run initial scan"><i class="bi bi-play"></i></button>
          <button class="btn btn-sm btn-outline-secondary" onclick="testWatchFolder(${idx})" title="Test folder access"><i class="bi bi-check2-circle"></i></button>
          <button class="btn btn-sm btn-outline-danger" onclick="removeWatchFolder(${idx})" title="Remove"><i class="bi bi-trash"></i></button>
        </div>
      </li>`;
    }).join('');
  }

  async function testWatchFolder(index){
    const folders = Array.isArray(window.__watchFolders) ? window.__watchFolders : [];
    const folder = folders[index];
    if(!folder){ return; }
    const createIfMissing = document.getElementById('wf-create-missing')?.checked || false;
    if(createIfMissing){
      const ok = confirm(`Create folder if missing?\n\n${folder}`);
      if(!ok){ return; }
    }
    const res = await fetch('/api/watch_folders/test', {
      method:'POST', credentials:'include', headers:{ 'Content-Type':'application/json', 'Authorization': __authHeader, 'X-CSRF-Token': getCsrfToken() },
      body: JSON.stringify({ folder, create: createIfMissing })
    });
    const data = await res.json().catch(()=>({}));
    if(res.ok){
      const msg = data.exists ? `Exists • Readable: ${data.readable} • Writable: ${data.writable}` : (data.message || 'Does not exist');
      showNotification(`Test ${folder}: ${msg}`, data.exists && data.readable && data.writable ? 'success' : 'warning');
    } else {
      showNotification('Test failed: ' + (data.error || res.status), 'danger');
    }
  }

  async function testSelectedWatchFolder(){
    const folders = Array.isArray(window.__watchFolders) ? window.__watchFolders : [];
    if(!folders.length){ showNotification('No folders to test', 'warning'); return; }
    await testWatchFolder(0);
  }

  async function openConfigActions(){
    try{
      const res = await fetch('/api/config_actions', { credentials:'include', headers:{ 'Authorization': __authHeader } });
      const data = await res.json().catch(()=>[]);
      const body = document.getElementById('config-actions-body');
      if(Array.isArray(data) && data.length){
        const rows = data.map(a => {
          const ts = a.timestamp || '';
          const action = a.action || '';
          const folder = a.folder || '';
          const result = a.result || '';
          return `<tr><td><small>${ts}</small></td><td><small>${action}</small></td><td><small><code>${folder}</code></small></td><td><small>${result}</small></td></tr>`;
        }).join('');
        body.innerHTML = `<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Time (UTC)</th><th>Action</th><th>Target</th><th>Result</th></tr></thead><tbody>${rows}</tbody></table></div>`;
      } else {
        body.innerHTML = '<div class="text-muted">No audit entries</div>';
      }
      const el = document.getElementById('configActionsModal');
      if(el && window.bootstrap){ const modal = bootstrap.Modal.getOrCreateInstance(el); modal.show(); }
    } catch(e){
      showNotification('Failed to load config actions: ' + e.message, 'danger');
    }
  }

  async function saveWatchFolders() {
    try {
      // Basic client-side validation
      const folders = Array.isArray(window.__watchFolders) ? window.__watchFolders : [];
      const invalid = folders.filter(f => !isValidPath(f));
      if (invalid.length) {
        showNotification('Invalid folder path(s): ' + invalid.join(', '), 'warning');
        return;
      }
      const res = await fetch('/api/watch_folders', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': __authHeader,
          'X-CSRF-Token': getCsrfToken()
        },
        body: JSON.stringify({ folders })
      });
      const resp = await res.json().catch(() => ({}));
      if (res.ok && resp.success) {
        showNotification('Watch folders saved', 'success');
        // Highlight any invalids reported (should be rare due to client validation)
        if (Array.isArray(resp.invalid) && resp.invalid.length) {
          showNotification('Some paths were rejected: ' + resp.invalid.join(', '), 'warning');
          markInvalidWatchFolders(resp.invalid);
        }
      } else {
        const serverInvalid = Array.isArray(resp.invalid) ? resp.invalid : [];
        if (serverInvalid.length) {
          showNotification('Invalid folder path(s): ' + serverInvalid.join(', '), 'danger');
          markInvalidWatchFolders(serverInvalid);
        } else {
          showNotification('Failed to save: ' + (resp.error || res.status), 'danger');
        }
      }
    } catch (e) {
      showNotification('Error saving watch folders: ' + e.message, 'danger');
    }
  }

  function markInvalidWatchFolders(invalidList) {
    const ul = document.getElementById('watch-folders-config-list');
    const items = ul.querySelectorAll('li');
    items.forEach(li => {
      const codeEl = li.querySelector('code');
      const path = codeEl ? codeEl.textContent : '';
      if (invalidList.includes(path)) {
        li.classList.add('list-group-item-warning');
        // add inline badge/icon
        const span = li.querySelector('span');
        if (span) {
          const badge = document.createElement('span');
          badge.className = 'ms-2 text-warning';
          badge.title = 'Invalid path';
          badge.innerHTML = '<i class="bi bi-exclamation-triangle"></i>';
          span.appendChild(badge);
        }
      }
    });
  }

  function isValidPath(p) {
    if (!p || typeof p !== 'string') return false;
    const s = p.trim();
    // Allow env placeholders
    const replaced = s.replace(/%USERNAME%|%USER%/g, 'user');
    // Windows UNC: \\server\share\path
    const isUNC = /^\\\\[^\\\/]+\\[^\\\/]+(\\.*)?$/.test(replaced);
    // Windows drive absolute: C:/ or C:\
    const isWinAbs = /^[A-Za-z]:[\\/].*/.test(replaced);
    // Linux absolute: starts with /
    const isLinuxAbs = replaced.startsWith('/');
    return isUNC || isWinAbs || isLinuxAbs;
  }
  
  // Show message if no results
  if (rows.length > 0 && visibleCount === 0) {
    const tbody = document.getElementById('users-tbody');
    const existingMsg = tbody.querySelector('.no-results-message');
    if (!existingMsg) {
      const noResultsRow = document.createElement('tr');
      noResultsRow.className = 'no-results-message';
      noResultsRow.innerHTML = '<td colspan="3" class="text-center text-muted"><i class="bi bi-search"></i> No users found</td>';
      tbody.appendChild(noResultsRow);
    }
  } else {
    document.querySelector('#users-tbody .no-results-message')?.remove();
  }
}

async function runInitialScan(index) {
  try {
    const folders = Array.isArray(window.__watchFolders) ? window.__watchFolders : [];
    const folder = folders[index];
    if (!folder) return;
    if (!isValidPath(folder)) {
      showNotification('Invalid folder path: ' + folder, 'warning');
      return;
    }
    const res = await fetch('/api/watch_folders/scan', {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': __authHeader,
        'X-CSRF-Token': getCsrfToken()
      },
      body: JSON.stringify({ folder })
    });
    const data = await res.json().catch(() => ({}));
    if (res.ok && data.success) {
      showNotification('Initial scan completed for: ' + folder, 'success');
    } else {
      showNotification('Initial scan failed: ' + (data.error || res.status), 'danger');
    }
  } catch (e) {
    showNotification('Error running initial scan: ' + e.message, 'danger');
  }
}

function clearUserSearch() {
  document.getElementById('search-users').value = '';
  filterUsers();
}

// Filter Roles table
function filterRoles() {
  const searchTerm = document.getElementById('search-roles').value.toLowerCase();
  const rows = document.querySelectorAll('#role-rights-tbody tr');
  let visibleCount = 0;
  
  rows.forEach(row => {
    const role = row.cells[0]?.textContent.toLowerCase() || '';
    const rights = row.cells[1]?.textContent.toLowerCase() || '';
    
    if (role.includes(searchTerm) || rights.includes(searchTerm)) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  });
}

function clearRoleSearch() {
  document.getElementById('search-roles').value = '';
  filterRoles();
}

// Filter Network Targets table
function filterNetworkTargets() {
  const searchTerm = document.getElementById('search-network-targets').value.toLowerCase();
  const rows = document.querySelectorAll('#network-targets-tbody tr');
  let visibleCount = 0;
  
  rows.forEach(row => {
    const name = row.cells[0]?.textContent.toLowerCase() || '';
    const path = row.cells[1]?.textContent.toLowerCase() || '';
    const cred = row.cells[2]?.textContent.toLowerCase() || '';
    
    if (name.includes(searchTerm) || path.includes(searchTerm) || cred.includes(searchTerm)) {
      row.style.display = '';
      visibleCount++;
    } else {
      row.style.display = 'none';
    }
  });
  
  if (rows.length > 0 && visibleCount === 0) {
    const tbody = document.getElementById('network-targets-tbody');
    const existingMsg = tbody.querySelector('.no-results-message');
    if (!existingMsg) {
      const noResultsRow = document.createElement('tr');
      noResultsRow.className = 'no-results-message';
      noResultsRow.innerHTML = '<td colspan="4" class="text-center text-muted"><i class="bi bi-search"></i> No network targets found</td>';
      tbody.appendChild(noResultsRow);
    }
  } else {
    document.querySelector('#network-targets-tbody .no-results-message')?.remove();
  }
}

function clearNetworkTargetSearch() {
  document.getElementById('search-network-targets').value = '';
  filterNetworkTargets();
}

// Filter Logs with highlighting
let originalStdoutContent = '';
let originalStderrContent = '';

function filterLogs() {
  const searchTerm = document.getElementById('search-logs').value;
  const stdoutLog = document.getElementById('stdout-log');
  const stderrLog = document.getElementById('stderr-log');
  
  // Store original content if not already stored
  if (!originalStdoutContent && stdoutLog.textContent) {
    originalStdoutContent = stdoutLog.textContent;
  }
  if (!originalStderrContent && stderrLog.textContent) {
    originalStderrContent = stderrLog.textContent;
  }
  
  if (!searchTerm) {
    // Restore original content without highlighting
    stdoutLog.innerHTML = escapeHtml(originalStdoutContent);
    stderrLog.innerHTML = escapeHtml(originalStderrContent);
    return;
  }
  
  // Highlight matching lines
  const highlightLines = (content) => {
    if (!content) return '';
    const lines = content.split('\n');
    return lines.map(line => {
      if (line.toLowerCase().includes(searchTerm.toLowerCase())) {
        return `<mark style="background-color: yellow; color: black;">${escapeHtml(line)}</mark>`;
      }
      return `<span style="opacity: 0.4;">${escapeHtml(line)}</span>`;
    }).join('\n');
  };
  
  stdoutLog.innerHTML = highlightLines(originalStdoutContent);
  stderrLog.innerHTML = highlightLines(originalStderrContent);
  
  // Scroll to first match
  const firstMatch = stdoutLog.querySelector('mark') || stderrLog.querySelector('mark');
  if (firstMatch) {
    firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }
}

function clearLogSearch() {
  document.getElementById('search-logs').value = '';
  filterLogs();
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Update log streaming to preserve search
const originalStreamLog = window.streamLog;
if (originalStreamLog) {
  window.streamLog = function(logType) {
    originalStreamLog(logType);
    // Reset original content cache when logs update
    setTimeout(() => {
      if (logType === 'stdout') {
        originalStdoutContent = document.getElementById('stdout-log').textContent;
      } else {
        originalStderrContent = document.getElementById('stderr-log').textContent;
      }
      // Reapply filter if search is active
      const searchTerm = document.getElementById('search-logs')?.value;
      if (searchTerm) {
        filterLogs();
      }
    }, 100);
  };
}

// Export/Import Configuration Functions
async function exportConfig() {
  try {
    const response = await fetch('/api/config/export', {
      method: 'GET',
      headers: {
        'Authorization': 'Basic ' + btoa(__authHeader || 'admin:'),
      }
    });
    
    if (!response.ok) {
      throw new Error(`Export failed: ${response.statusText}`);
    }
    
    // Get filename from Content-Disposition header or generate one
    const disposition = response.headers.get('Content-Disposition');
    let filename = 'organizer_backup.json';
    if (disposition && disposition.includes('filename=')) {
      const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(disposition);
      if (matches != null && matches[1]) {
        filename = matches[1].replace(/['"]/g, '');
      }
    }
    
    // Download the file
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
    
    showNotification('Configuration exported successfully!', 'success');
  } catch (error) {
    console.error('Export error:', error);
    showNotification(`Export failed: ${error.message}`, 'danger');
  }
}

async function handleImportFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // First validate the file
  const formData = new FormData();
  formData.append('file', file);
  
  try {
    const validateResponse = await fetch('/api/config/validate', {
      method: 'POST',
      headers: {
        'Authorization': 'Basic ' + btoa(__authHeader || 'admin:'),
        'X-CSRFToken': __csrfToken
      },
      body: formData
    });
    
    const validation = await validateResponse.json();
    
    if (!validation.valid) {
      let errorMsg = 'Invalid configuration file';
      if (validation.errors && validation.errors.length > 0) {
        errorMsg += ':\n- ' + validation.errors.join('\n- ');
      }
      showNotification(errorMsg, 'danger');
      event.target.value = ''; // Clear the input
      return;
    }
    
    // Show warnings if any
    if (validation.warnings && validation.warnings.length > 0) {
      const warningMsg = 'Warnings:\n- ' + validation.warnings.join('\n- ');
      console.warn(warningMsg);
    }
    
    // Confirm import
    const confirmMsg = `Import configuration backup?\n\nExported: ${validation.export_timestamp || 'unknown'}\nVersion: ${validation.export_version || 'unknown'}\n\nThis will replace current settings. Continue?`;
    
    if (!confirm(confirmMsg)) {
      event.target.value = '';
      return;
    }
    
    // Perform import
    const importFormData = new FormData();
    importFormData.append('file', file);
    importFormData.append('import_organizer', 'true');
    importFormData.append('import_dashboard', 'true');
    
    const importResponse = await fetch('/api/config/import', {
      method: 'POST',
      headers: {
        'Authorization': 'Basic ' + btoa(__authHeader || 'admin:'),
        'X-CSRFToken': __csrfToken
      },
      body: importFormData
    });
    
    const result = await importResponse.json();
    
    if (result.success) {
      showNotification('Configuration imported successfully! Reloading...', 'success');
      setTimeout(() => {
        window.location.reload();
      }, 2000);
    } else {
      throw new Error(result.error || 'Import failed');
    }
    
  } catch (error) {
    console.error('Import error:', error);
    showNotification(`Import failed: ${error.message}`, 'danger');
  } finally {
    event.target.value = ''; // Clear the input
  }
}
</script>
<script>
async function loadFeaturesConfig(){
  try{
    const r = await fetch('/organizer_config.json', {cache:'no-store'});
    if(r.ok){
      const org = await r.json();
      document.getElementById('cfg-vt-api-key').value = org.vt_api_key || '';
      const feats = org.features || {};
      document.getElementById('cfg-feat-virustotal').checked = feats.virustotal_enabled !== false;
      document.getElementById('cfg-feat-duplicates').checked = feats.duplicates_enabled !== false;
      document.getElementById('cfg-feat-reports').checked = feats.reports_enabled !== false;
    }
  } catch(e){ /* ignore */ }
}

async function saveFeaturesConfig(){
  const vtApiKey = document.getElementById('cfg-vt-api-key').value.trim();
  const features = {
    virustotal_enabled: document.getElementById('cfg-feat-virustotal').checked,
    duplicates_enabled: document.getElementById('cfg-feat-duplicates').checked,
    reports_enabled: document.getElementById('cfg-feat-reports').checked
  };
  try{
    const r = await fetch('/api/update', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ vt_api_key: vtApiKey, features })
    });
    const j = await r.json().catch(()=>({}));
    if(r.ok){ showNotification('Features saved', 'success'); }
    else { showNotification('Failed to save features: ' + (j.message||r.status), 'warning'); }
  } catch(e){ showNotification('Error saving features: ' + e.message, 'danger'); }
}

document.addEventListener('DOMContentLoaded', loadFeaturesConfig);
</script>
{% endblock %}