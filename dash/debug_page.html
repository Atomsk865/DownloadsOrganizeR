{% extends "dashboard_base.html" %}

{% block title %}Environment & Debugging - DownloadsOrganizeR{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/core.css') }}">
<style>
    #env-log {
        min-height: 400px;
        max-height: 600px;
        overflow-y: auto;
        background-color: var(--bg-secondary, #f8f9fa);
        border: 1px solid var(--border-color, #dee2e6);
        border-radius: 8px;
        padding: 1rem;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
    }
    
    .test-result {
        background-color: var(--bg-primary, #ffffff);
    }
    
    .test-result pre {
        max-height: 200px;
        overflow-y: auto;
        font-size: 0.8rem;
    }
    
    .debug-action-btn {
        min-width: 150px;
    }
    
    .test-stats-card {
        transition: transform 0.2s;
    }
    
    .test-stats-card:hover {
        transform: translateY(-2px);
    }
    
    .dev-only-badge {
        display: none;
    }
    
    body.developer-mode .dev-only-badge {
        display: inline-block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4" data-theme="{{ theme_mode }}">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-bug me-2"></i>Environment & Debugging Suite</h2>
            <p class="text-muted mb-0">Comprehensive testing and diagnostics tools for developers</p>
            <span class="badge bg-primary dev-only-badge mt-2">
                <i class="bi bi-code-slash"></i> Developer Mode Active
            </span>
        </div>
        <a href="/" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>

    <!-- Test Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card test-stats-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Total Tests</h6>
                            <h3 class="mb-0" id="stat-total-tests">0</h3>
                        </div>
                        <i class="bi bi-list-check text-primary" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card test-stats-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Passed</h6>
                            <h3 class="mb-0 text-success" id="stat-passed">0</h3>
                        </div>
                        <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card test-stats-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Warnings</h6>
                            <h3 class="mb-0 text-warning" id="stat-warnings">0</h3>
                        </div>
                        <i class="bi bi-exclamation-triangle text-warning" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card test-stats-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Failed</h6>
                            <h3 class="mb-0 text-danger" id="stat-failed">0</h3>
                        </div>
                        <i class="bi bi-x-circle text-danger" style="font-size: 2rem;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Actions Panel -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-play-circle me-2"></i>Test Actions
                </div>
                <div class="card-body">
                    <div class="d-grid gap-3">
                        <button id="run-all-tests" class="btn btn-primary debug-action-btn">
                            <i class="bi bi-arrow-clockwise me-2"></i>
                            Run All API Tests
                        </button>
                        
                        <button id="run-pytests" class="btn btn-info debug-action-btn">
                            <i class="bi bi-terminal me-2"></i>
                            Run Pytest Suite
                        </button>
                        
                        <button id="run-self-test" class="btn btn-success debug-action-btn">
                            <i class="bi bi-shield-check me-2"></i>
                            Smart Self-Test
                        </button>
                        
                        <hr class="my-2">
                        
                        <button id="clear-log" class="btn btn-outline-secondary debug-action-btn">
                            <i class="bi bi-trash me-2"></i>
                            Clear Log
                        </button>
                    </div>
                    
                    <!-- Test Info -->
                    <div class="mt-4 pt-3 border-top">
                        <h6 class="mb-3">About Tests</h6>
                        <div class="small text-muted">
                            <p><b>API Tests:</b> Check all dashboard API endpoints</p>
                            <p><b>Pytest Suite:</b> Run Python unit tests</p>
                            <p><b>Smart Self-Test:</b> Comprehensive environment validation</p>
                        </div>
                    </div>
                    
                    <!-- Last Run -->
                    <div class="mt-3 pt-3 border-top">
                        <h6 class="mb-2">Last Test Run</h6>
                        <div class="small text-muted" id="last-run-time">Never</div>
                    </div>
                </div>
            </div>
            
            <!-- Developer Mode Info (Dev-only) -->
            <div class="card mt-3 dev-only-element" style="display: none;">
                <div class="card-header bg-dark text-white">
                    <i class="bi bi-code-slash me-2"></i>Developer Info
                </div>
                <div class="card-body">
                    <div class="small">
                        <p><b>Mode:</b> <span class="badge bg-success">Developer</span></p>
                        <p><b>Environment:</b> Development</p>
                        <p><b>Debugging:</b> Enabled</p>
                        <p class="mb-0"><b>Console:</b> Press F12</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Log Panel -->
        <div class="col-md-8 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-journal-code me-2"></i>Test Log & Results</span>
                    <span class="badge bg-light text-dark" id="log-entry-count">0 entries</span>
                </div>
                <div class="card-body p-0">
                    <div id="env-log"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Reference -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-book me-2"></i>Quick Reference
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>API Endpoints Tested</h6>
                            <ul class="small">
                                <li><code>/api/env/ping</code> - Health check</li>
                                <li><code>/api/organizer/config</code> - Configuration</li>
                                <li><code>/api/recent_files</code> - Recent files</li>
                                <li><code>/status</code> - Service status</li>
                                <li><code>/api/duplicates</code> - Duplicate detection</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Test Categories</h6>
                            <ul class="small">
                                <li><b>Authentication:</b> Login & session validation</li>
                                <li><b>API Health:</b> Endpoint availability</li>
                                <li><b>Features:</b> Dashboard modules check</li>
                                <li><b>Storage:</b> Browser localStorage/cookies</li>
                                <li><b>Network:</b> Connectivity & latency</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Container -->
<div id="notification-container" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>
{% endblock %}

{% block additional_js %}
<!-- Core Library (Foundation) -->
<script type="module" src="{{ url_for('static', filename='js/modules/core-library.js') }}"></script>

<!-- Module System (Framework) -->
<script type="module" src="{{ url_for('static', filename='js/modules/module-system.js') }}"></script>

<!-- Debug Suite Module -->
<script type="module" src="{{ url_for('static', filename='js/modules/debug-suite.js') }}"></script>

<!-- Developer Mode Module -->
<script type="module" src="{{ url_for('static', filename='js/modules/developer-mode.js') }}"></script>

<!-- Initialize Debug Page -->
<script type="module">
    import { ModuleSystem } from '{{ url_for('static', filename='js/modules/module-system.js') }}';
    import { Store, EventBus } from '{{ url_for('static', filename='js/modules/core-library.js') }}';
    import DebugSuite from '{{ url_for('static', filename='js/modules/debug-suite.js') }}';
    import DeveloperMode from '{{ url_for('static', filename='js/modules/developer-mode.js') }}';

    // Register modules
    ModuleSystem.register('debug-suite', DebugSuite);
    ModuleSystem.register('developer-mode', DeveloperMode);

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', async () => {
            await ModuleSystem.initAll();
            console.log('✅ Debug page modules initialized');
            
            // Subscribe to test results to update stats
            const debugSuite = ModuleSystem.get('debug-suite');
            if (debugSuite) {
                debugSuite.onState('results', (results) => {
                    updateStats(results);
                });
                
                debugSuite.onState('lastRun', (lastRun) => {
                    if (lastRun) {
                        const date = new Date(lastRun);
                        document.getElementById('last-run-time').textContent = date.toLocaleString();
                    }
                });
            }
        });
    } else {
        await ModuleSystem.initAll();
        console.log('✅ Debug page modules initialized');
    }
    
    // Update statistics display
    function updateStats(results) {
        document.getElementById('stat-total-tests').textContent = results.total || 0;
        document.getElementById('stat-passed').textContent = results.passed || 0;
        document.getElementById('stat-warnings').textContent = results.warnings || 0;
        document.getElementById('stat-failed').textContent = results.failed || 0;
        
        // Update log entry count
        const logEntries = document.querySelectorAll('#env-log > div').length;
        document.getElementById('log-entry-count').textContent = `${logEntries} ${logEntries === 1 ? 'entry' : 'entries'}`;
    }
    
    // Make updateStats available globally for event handlers
    window.updateStats = updateStats;
</script>
{% endblock %}
